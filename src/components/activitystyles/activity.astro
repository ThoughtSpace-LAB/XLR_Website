---
/* eslint-disable */
import { Image } from 'astro:assets';
import '~/styles/activity/bless/activity-background.css';
import '~/styles/feature-text.css';
import '~/styles/activity/bless/activity-input.css';
import '~/styles/activity/bless/activity-loading.css';
import '~/styles/activity/bless/activity-wish.css';
import heroBg from '~/assets/images/activityimages/bless/activity-mainbg.png';
import cardBg from '~/assets/images/activityimages/bless/card-BG.jpg';
import cardwheel from '~/assets/images/activityimages/bless/card-wheel.jpg';
import cardshadow from '~/assets/images/activityimages/bless/card-shadow.jpg';
import activityline from '~/assets/images/activityimages/bless/1activity-line.svg';
---

<div class="relative">
  <a href="/" aria-label="Back to home" class="fixed top-4 right-4 md:top-6 md:right-6 z-50 inline-flex items-center gap-2 py-2 px-3 bg-white/10 text-white rounded-full hover:bg-white/20 transition-all text-sm md:text-base">
    ← Back
  </a>

  <section id="activity-page" class=" h-[100vh] w-full flex items-center justify-center bg-black relative">
  <div class="w-full h-full absolute inset-0 z-0 opacity-70">
    <img 
      src={heroBg.src}
      width={heroBg.width}
      height={heroBg.height}
      class="w-full h-full object-cover" 
      alt="背景图"
    />
  </div>

  <div class="relative z-10 flex flex-col items-center justify-center h-[90vh] w-[95vw] md:w-[75vw]" id="window-wrapper">

  <div class="w-full h-full overflow-hidden flex items-center justify-center" id="slider-window">
    <div class="flex w-full h-full transition-transform duration-700 ease-in-out" id="slider-track">
      
      <!-- Step 1 Container -->
      <div class="w-full h-full flex-shrink-0 flex flex-col items-center justify-center px-4" id="step-1">
        <div class="flex flex-col w-full max-w-xl" id="pagewrapper">
          <h1 class="activity-headline text-2xl md:text-5xl text-center mb-4">Begin Your Wishing Journey</h1>
          <div class="w-full h-[5vh] md:h-[10vh] relative inset-0 z-0 opacity-90">
            <img 
            src={activityline.src}
            width={activityline.width}
            height={activityline.height}
            class="w-full h-[2vh] md:h-[4vh] object-contain drop-shadow-[0_0_10px_rgba(239,226,151,1)]" 
            alt="cuttingline"
            />
          </div>
          
          <h1 class="activity-paragraph text-center mb-10 px-10 text-sm md:text-base">
            Your information is only used to deliver your guidance.<br class="hidden md:block" />
            We respect your privacy and your space.
          </h1>
          
          <!-- Gender single-choice (radio-backed) -->
          <div id="gender-input" class="nebula-input flex flex-row w-full items-center justify-center z-20">
            <div class="gender-options w-full md:w-[50vw] justify-evenly mx-auto" role="radiogroup" aria-labelledby="gender-label">
              <input type="radio" id="gender-female" name="gender" value="female" required />
              <label class="gender-option" for="gender-female">Female</label>

              <input type="radio" id="gender-male" name="gender" value="male" required />
              <label class="gender-option" for="gender-male">Male</label>
            </div>
            <div class="nebula-particle" style="--x:0.2; --y:-0.4; --delay:0.1s"></div>
            <div class="nebula-particle" style="--x:0.5; --y:-0.2; --delay:0.3s"></div>
          </div>

          <div id="email-input" class="nebula-input z-20 py-5 w-[60vw] md:max-w-md mx-auto align-center">
          <input type="email" name="email" autocomplete="email" class="input w-full" required />
          <label class="user-label">Email Address</label>
          <div class="nebula-particle" style="--x:0.2; --y:-0.4; --delay:0.1s"></div>
          <div class="nebula-particle" style="--x:0.5; --y:-0.2; --delay:0.3s"></div>
          <div class="nebula-particle" style="--x:0.3; --y:0.3; --delay:0.5s"></div>
          <div class="nebula-particle" style="--x:0.7; --y:0.1; --delay:0.2s"></div>
          <div class="nebula-particle" style="--x:0.1; --y:-0.7; --delay:0.4s"></div>
          <div class="nebula-particle" style="--x:0.6; --y:0.4; --delay:0.6s"></div>
          </div>

          <!-- Continue button -->
          <div class="w-full flex items-center justify-center mt-6">
            <a href="#" class="continue-button-bg z-50 relative" id="continueBtn-step1">
              Continue
            </a>
          </div>
        </div>
      </div>

      <!-- Step 2 Container -->
      <div class="w-full h-full flex-shrink-0 flex flex-col items-center justify-center px-4" id="step-2">
        
         <!-- 卡牌背景 Card Background Wrapper -->
         <div class="relative w-full h-full flex justify-center items-center overflow-hidden" id="card-bg-wrapper">
            <div class="absolute inset-0 z-0 flex items-center justify-center pointer-events-none">
               <img 
                 src={cardBg.src}
                 class="h-[85vh] w-auto object-contain shadow-[0_0_50px_rgba(0,0,0,0.8)] rounded-4xl" 
                 alt="Card Background" 
               />
            </div>
            <div class="absolute inset-0 z-10 pointer-events-none">
               <img 
                 src={cardwheel.src}
                 id="card-wheel-img"
                 class="absolute left-1/2 -translate-x-1/2 bottom-0 h-[30vh] object-contain animate-pulse transition-all duration-1000 ease-in-out" 
                 style="animation-duration: 2s;"
                 alt="Card Wheel" 
               />
            </div>

            <!-- Step 2 文字内容 -->
            <div class="relative z-10 flex flex-col items-center justify-center h-full w-[75vw] max-w-[300px] md:w-[30vw] lg:w-[25vw] overflow-hidden" id="step-wrapper">
              <div class="flex w-full h-full transition-transform duration-700 ease-in-out" id="step-2-track">

                <!-- Step 2-1: Number Input and Question -->
                <div class="w-full h-full flex-shrink-0 flex flex-col items-center justify-center gap-4 md:gap-6" id="step-2-1">
                  <a href="#" class="relative z-50 text-white/40 hover:text-white transition-all text-xs md:text-sm uppercase tracking-widest" id="backBtn-step2">
                  ← Back
                  </a>
              <h1 class="activity-headline text-2xl md:text-4xl text-center" id="Manifestation">Manifestation</h1>
              <h1 class="activity-paragraph text-center px-2 text-sm md:text-base">
                  Write down 2 lucky numbers and ask your question.
              </h1>
                  <div class="flex flex-col w-full" id="pagewrapper">
                    <div class="flex flex-row justify-evenly gap-4 md:gap-6" id="numbers-inputs">
                      <div id="number-input-1" class="nebula-input relative z-20 w-1/3 md:w-30 lg:w-35">
                        <input type="text" name="text" autocomplete="off" class="input w-full" required />
                        <label class="user-label">No.1</label>
                        <div class="nebula-particle" style="--x:0.2; --y:-0.4; --delay:0.1s"></div>
                        <div class="nebula-particle" style="--x:0.5; --y:-0.2; --delay:0.3s"></div>
                        <div class="nebula-particle" style="--x:0.3; --y:0.3; --delay:0.5s"></div>
                        <div class="nebula-particle" style="--x:0.7; --y:0.1; --delay:0.2s"></div>
                        <div class="nebula-particle" style="--x:0.1; --y:-0.7; --delay:0.4s"></div>
                        <div class="nebula-particle" style="--x:0.6; --y:0.4; --delay:0.6s"></div>
                      </div>

                      <div id="number-input-2" class="nebula-input relative z-20 w-1/3 md:w-30 lg:w-35">
                        <input type="text" name="text" autocomplete="off" class="input w-full" required />
                        <label class="user-label">No.2</label>
                        <div class="nebula-particle" style="--x:0.2; --y:-0.4; --delay:0.1s"></div>
                        <div class="nebula-particle" style="--x:0.5; --y:-0.2; --delay:0.3s"></div>
                        <div class="nebula-particle" style="--x:0.3; --y:0.3; --delay:0.5s"></div>
                        <div class="nebula-particle" style="--x:0.7; --y:0.1; --delay:0.2s"></div>
                        <div class="nebula-particle" style="--x:0.1; --y:-0.7; --delay:0.4s"></div>
                        <div class="nebula-particle" style="--x:0.6; --y:0.4; --delay:0.6s"></div>
                      </div>
                    </div>
              
                    <!-- Custom Question (Line Style) -->
                    <div id="custom-question-input" class="nebula-input line-style flex flex-col justify-center items-center z-20 w-full mt-2">
                      <textarea required name="custom-question" rows="1" class=" input justify-center items-center w-[70vw] md:w-full overflow-hidden" placeholder=" "></textarea>
                      <label class="user-label px-8">Ask your question...</label>
                      <div class="nebula-particle" style="--x:0.2; --y:-0.4; --delay:0.1s"></div>
                      <div class="nebula-particle" style="--x:0.5; --y:-0.2; --delay:0.3s"></div>
                      <div class="nebula-particle" style="--x:0.3; --y:0.3; --delay:0.5s"></div>
                      <div class="nebula-particle" style="--x:0.7; --y:0.1; --delay:0.2s"></div>
                      <div class="nebula-particle" style="--x:0.1; --y:-0.7; --delay:0.4s"></div>
                      <div class="nebula-particle" style="--x:0.6; --y:0.4; --delay:0.6s"></div>
                    </div>
            
                    <!-- Continue button for Step 2-1 -->
                    <div class="w-full flex justify-center mt-6">
                      <a href="#" class="continue-button-bg z-50 relative" id="continueBtn-step2-1">
                        Continue
                      </a>
                    </div>
                  </div>
                </div>

                <!-- Step 2-1b: Choose Calculation Model -->
                <div class="w-full h-full flex-shrink-0 flex flex-col items-center justify-center gap-4 md:gap-6" id="step-2-1b">
                  <a href="#" class="relative z-50 text-white/40 hover:text-white transition-all text-xs md:text-sm uppercase tracking-widest" id="backBtn-step2-1b">
                  ← Back
                  </a>
              <h1 class="activity-headline text-2xl md:text-4xl text-center">Choose Path</h1>
              <h1 class="activity-paragraph text-center px-2 text-sm md:text-base">
                  Select the model for your revelation.
              </h1>
                  <div class="flex flex-col w-full" id="pagewrapper">
                    <div class="flex flex-col gap-3 md:gap-4 w-full">
                      <!-- Model 1 Button -->
                      <button class="model-option-btn flex flex-col items-start gap-1.5 md:gap-2 p-4 md:p-5 rounded-lg border border-white/20 hover:border-gold/80 hover:bg-white/[0.2] press transition-all duration-300 z-20 text-left overflow-hidden group relative" id="model-luca">
                        <div class="absolute inset-0 bg-gradient-to-r from-white/0 via-white/5 to-white/0 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none"></div>
                        <div class="absolute inset-0 rounded-lg opacity-0 transition-opacity duration-500 pointer-events-none" style="box-shadow: inset 0 0 0 1px rgba(212, 175, 55, 0), 0 0 20px rgba(212, 175, 55, 0); filter: drop-shadow(0 0 0px rgba(212, 175, 55, 0));" id="model-luca-glow"></div>
                        <div class="relative">
                          <h2 class="text-sm md:text-base font-medium text-white/95">LUCA</h2>
                          <p class="text-xs md:text-xs text-white/60 hover:text-white">Luck + Calculation</p>
                          <p class="text-xs md:text-xs text-white/50 mt-1">Predict minor events within a month. For immediate, minor matters. Best for quick binary outcomes or daily forecasts (e.g., "Will it rain?").</p>
                        </div>
                      </button>

                      <!-- Model 2 Button -->
                      <button class="model-option-btn flex flex-col items-start gap-1.5 md:gap-2 p-4 md:p-5 rounded-lg border border-white/20 hover:border-gold/80 hover:bg-white/[0.2] transition-all duration-300 z-20 text-left overflow-hidden group relative" id="model-zora">
                        <div class="absolute inset-0 bg-gradient-to-r from-white/0 via-white/5 to-white/0 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none"></div>
                        <div class="absolute inset-0 rounded-lg opacity-0 transition-opacity duration-500 pointer-events-none" style="box-shadow: inset 0 0 0 1px rgba(212, 175, 55, 0), 0 0 20px rgba(212, 175, 55, 0); filter: drop-shadow(0 0 0px rgba(212, 175, 55, 0));" id="model-zora-glow"></div>
                        <div class="relative">
                          <h2 class="text-sm md:text-base font-medium text-white/95">ZORA</h2>
                          <p class="text-xs md:text-xs text-white/60">Zodiac + Aura</p>
                          <p class="text-xs md:text-xs text-white/50 mt-1">Predict events within six months. For complex, long-term trajectories. It tracks the shifting dynamics of a situation and identifies the strategic key to a breakthrough.</p>
                        </div>
                      </button>
                    </div>
            
                    <!-- Continue button for Step 2-1b -->
                    <div class="w-full flex justify-center mt-6">
                      <a href="#" class="continue-button-bg z-50 relative" id="continueBtn-step2-1b-placeholder">
                        Continue
                      </a>
                    </div>
                  </div>
                </div>

                <!-- Step 2-2: Card Selection (Placeholder for now) -->
                <div class="relative w-full h-full flex-shrink-0 flex flex-col items-center justify-center gap-4 md:gap-6 px-5" id="step-2-2">
                   
                   <!-- Loader currently visible constantly in step 2-2 -->
                   <div class="loader-container">
                      <div class="loader"></div>
                      <div id="loading-text" class="loading-text w-full max-w-md md:w-[30vw] lg:w-[25vw]">Casting...</div>
                   </div>

                   <div id="step2-card-placeholder" class="absolute bottom-0 left-1/2 -translate-x-1/2 flex flex-col items-center gap-4 md:gap-8 opacity-0 blur-md translate-y-[100px] transition-all duration-1000 ease-out">
                      <img 
                      src={cardshadow.src}
                      class="h-[40vh] md:h-[50vh] object-contain rounded-4xl" 
                      alt="Card Shadow" 
                      />
                   </div>
                </div>
                <!-- Step 2-3: Answer -->
                <div class="w-full h-full flex-shrink-0 flex flex-col items-center justify-center gap-4 p-2 md:p-4" id="step-2-3">
                    <h1 class="activity-headline text-xl md:text-3xl text-center mb-1">Revelation</h1>
                    
                    <!-- Tabs -->
                    <div class="flex flex-wrap gap-1.5 md:gap-2 justify-center w-full max-w-4xl z-50">
                        <button class="tab-btn active-tab text-xs md:text-sm px-2.5 py-1" data-tab="analysis">Analysis</button>
                        <button class="tab-btn text-xs md:text-sm px-2.5 py-1" data-tab="spirits">Spirits</button>
                        <button class="tab-btn text-xs md:text-sm px-2.5 py-1" data-tab="interpretation">Interp.</button>
                        <button class="tab-btn text-xs md:text-sm px-2.5 py-1" data-tab="advice">Advice</button>
                        <button class="tab-btn text-xs md:text-sm px-2.5 py-1" data-tab="wisdom">Wisdom</button>
                    </div>

                    <!-- Content Box -->
                    <div class="w-full max-w-4xl h-[45vh] md:h-[50vh] bg-black/40 backdrop-blur-md border border-white/10 rounded-xl p-4 md:p-6 overflow-y-auto content-box-scroll z-50 shadow-2xl">
                        <div id="result-content" class="text-white/90 text-sm md:text-lg leading-relaxed font-serif">
                            <!-- Content will be injected here -->
                            <p class="animate-pulse">Loading revelation...</p>
                        </div>
                    </div>
                    
                    <!-- Fly to Lantern Button -->
                    <div class="w-full flex justify-center mt-2 md:mt-4">
                        <button id="goToStep3Btn" class="continue-button-bg z-50 relative text-sm md:text-base">
                            Bless My Wish
                        </button>
                    </div>

                </div>
              </div>
            </div>

            <!-- Step 2-3 Overlay Logic: The Revelation -->
            <!-- Note: Revelation and Lantern are handled via overlays or top-level slider movements -->
         </div>
      </div>

    </div>

    
  </div>

  </div>

  <!-- Step 3 Container: Sky Lantern Wish (Full Screen) -->
  <div id="step-3" class="fixed inset-0 z-[100] pointer-events-none">
     <div id="wish-overlay" class="wish-overlay">
        <div id="lanterns-layer" class="absolute inset-0 pointer-events-none">
          <div class="lantern-container main-lantern">
             <div class="lantern">
                <div class="lantern-fire"></div>
             </div>
          </div>
        </div>
        
        <div class="wish-content px-4 py-8">
           <div id="wish-input-section" class="w-full max-w-[80vw] mx-auto">
             <div class="wish-input-wrapper mb-6">
                <div class="nebula-input line-style w-full">
                  <textarea id="user-wish" name="wish" required rows="1" class="input w-full resize-none overflow-hidden text-lg md:text-xl" placeholder=" "></textarea>
                  <label class="user-label">Write your wish here...</label>
                  <div class="nebula-particle" style="--x:0.2; --y:-0.4; --delay:0.1s"></div>
                  <div class="nebula-particle" style="--x:0.5; --y:-0.2; --delay:0.3s"></div>
                  <div class="nebula-particle" style="--x:0.3; --y:0.3; --delay:0.5s"></div>
                  <div class="nebula-particle" style="--x:0.7; --y:0.1; --delay:0.2s"></div>
                  <div class="nebula-particle" style="--x:0.1; --y:-0.7; --delay:0.4s"></div>
                  <div class="nebula-particle" style="--x:0.6; --y:0.4; --delay:0.6s"></div>
                </div>
             </div>

             <div class="quantity-selector flex items-center justify-center gap-4 mb-6">
                <span class="text-white/60 uppercase tracking-widest text-xs md:text-sm">Lanterns</span>
                <div class="flex items-center gap-3">
                  <button class="qty-btn" id="qty-minus">-</button>
                  <span class="qty-value text-xl md:text-2xl text-white font-serif min-w-[2ch] text-center" id="qty-val">1</span>
                  <button class="qty-btn" id="qty-plus">+</button>
                </div>
             </div>

             <h2 class="wish-text text-lg md:text-2xl text-center text-white/90 font-serif leading-snug mb-8">
               Write your wish and let it soar to the skies!<br/> 
               <span class="wish-subtext block mt-2 text-xs md:text-sm text-white/40 uppercase tracking-widest">A one-dollar contribution for each blessing lantern.</span>
             </h2>
             <div class="wish-buttons flex flex-col gap-4">
                <button class="wish-btn w-auto px-8 py-3" id="wishBtn-make">Bless my wish</button>
                <button class="wish-btn w-auto px-8 py-3 variant-outline" id="wishBtn-exit">Exit</button>
             </div>
           </div>


        </div>
     </div>
  </div>

  </section>

  <!-- / STAR ANIMATION -->


  <div class="animation-wrapper pointer-events-none" aria-hidden="true">
    <div class="particle particle-1"></div>
    <div class="particle particle-2"></div>
    <div class="particle particle-3"></div>
    <div class="particle particle-4"></div>
  </div>

  <div class="page-wrapper pointer-events-none hidden"> 
    <h4>CSS Particles</h4>
  </div>

  <div class="absolute inset-0 pointer-events-none z-0">
    <div class="container">
      <div id="particles" class="circle-container" aria-hidden="true"></div>
    </div>
  </div>

  <script >
    if (typeof window !== 'undefined') {
      document.addEventListener('astro:page-load', () => {
        const container = document.getElementById('particles');
        if (!container) {
          console.debug('[particles] container not found');
          return;
        }
        console.debug('[particles] initializing');
        const NUM = 60; // lowered count to reduce initial load
        for (let i = 0; i < NUM; i++) {
          const d = document.createElement('div');
          d.className = 'circle';

          const size = (Math.random() * 12 + 4).toFixed(2); // px as float
          const moveX = (Math.random() * 100).toFixed(2); // vw as float
          const moveYStart = (Math.random() * 30 + 70).toFixed(2); // vh start
          const moveYEnd = - (parseFloat(moveYStart) + Math.random() * 30).toFixed(2);
          const duration = (14 + Math.random() * 12).toFixed(2) + 's';
          const delay = (Math.random() * 11).toFixed(2) + 's';
          const scaleStart = (0.4 + Math.random() * 0.4).toFixed(2);
          const scaleMid = (1.0 + Math.random() * 0.8).toFixed(2);

          d.style.setProperty('--size', size + 'px');
          d.style.setProperty('--move-x', moveX + 'vw');
          d.style.setProperty('--move-y-start', moveYStart + 'vh');
          d.style.setProperty('--move-y-end', moveYEnd + 'vh');
          d.style.setProperty('--move-duration', duration);
          d.style.setProperty('--move-delay', delay);
          d.style.setProperty('--scale-start', scaleStart);
          d.style.setProperty('--scale-mid', scaleMid);

          // small jitter so not all start at same time
          d.style.setProperty('--fade-duration', (6 + Math.random() * 4).toFixed(2) + 's');

          container.appendChild(d);
        }
        console.debug('[particles] appended', NUM);
        // Reveal particles with a single class to avoid flash/stacking
        setTimeout(() => container.classList.add('initialized'), 50);
      });
    }
  </script>

  <script >
    import { actions } from 'astro:actions';

    document.addEventListener('astro:page-load', () => {
      // Auto-resize textareas
      const textareas = document.querySelectorAll('.nebula-input textarea.input') as NodeListOf<HTMLTextAreaElement>;
      textareas.forEach(textarea => {
        function autoResize() {
          textarea.style.height = 'auto'; // Reset height to recalculate
          textarea.style.height = (textarea.scrollHeight) + 'px';
        }
        textarea.addEventListener('input', autoResize);
        // Initial resize
        autoResize();
      });

      const sliderTrack = document.getElementById('slider-track');
      const step2Track = document.getElementById('step-2-track');

      // Step 1 -> Step 2
      const continueBtnStep1 = document.getElementById('continueBtn-step1');
      if (continueBtnStep1 && sliderTrack) {
        continueBtnStep1.addEventListener('click', (e) => {
          e.preventDefault();

          const gender = document.querySelector('input[name="gender"]:checked');
          const email = (document.querySelector('input[name="email"]') as HTMLInputElement);
          
          if (!gender) {
            alert("Please select your gender.");
            return;
          }
          if (!email || !email.value.trim()) {
            alert("Please enter your email address.");
            return;
          }
          
          // Validate email format (@xxx.com)
          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (!emailRegex.test(email.value.trim())) {
            alert("Please enter a valid email address (e.g., user@example.com).");
            return;
          }

          sliderTrack.style.transform = 'translateX(-100%)';
        });
      }

      // Step 2 Back Button Logic
      const backBtnStep2 = document.getElementById('backBtn-step2');
      if (backBtnStep2 && sliderTrack && step2Track) {
        backBtnStep2.addEventListener('click', (e) => {
          e.preventDefault();
          // Check if we are in Step 2-2 (translated)
          const currentTransform = step2Track.style.transform;
          
          if (currentTransform === 'translateX(-200%)') {
             // Go back to Step 2-1b from Step 2-2
             step2Track.style.transform = 'translateX(-100%)';
             
             // Reset Step 2-2 card animation
             const cardPlaceholder = document.getElementById('step2-card-placeholder');
             const cardWheelImg = document.getElementById('card-wheel-img');

             if (cardWheelImg) {
                cardWheelImg.classList.add('bottom-0');
                cardWheelImg.classList.remove('bottom-1/2', 'translate-y-2/3');
             }

             if(cardPlaceholder) {
                setTimeout(() => {
                    cardPlaceholder.classList.add('translate-y-[200px]', 'opacity-0', 'blur-md');
                    cardPlaceholder.classList.remove('translate-y-0', 'opacity-100', 'blur-0');
                }, 500); // Reset after transition back
             }

          } else if (currentTransform === 'translateX(-100%)') {
             // Go back to Step 2-1 from Step 2-1b
             step2Track.style.transform = 'translateX(0)';
             
          } else {
             // Go back to Step 1
             sliderTrack.style.transform = 'translateX(0)';
          }
        });
      }

      // Step 2-1 -> Step 2-1b
      const continueBtnStep2_1 = document.getElementById('continueBtn-step2-1');
      if (continueBtnStep2_1 && step2Track) {
        continueBtnStep2_1.addEventListener('click', async (e) => {
          e.preventDefault();

          const numbers = (document.querySelectorAll('#numbers-inputs input') as NodeListOf<HTMLInputElement>);
          const question = (document.querySelector('textarea[name="custom-question"]') as HTMLTextAreaElement);
          
          let allNumbersFilled = true;
          numbers.forEach(input => {
            if (!input.value.trim()) allNumbersFilled = false;
          });
          
          if (!allNumbersFilled) {
            alert("Please enter your lucky numbers.");
            return;
          }
          if (!question || !question.value.trim()) {
            alert("Please ask your question.");
            return;
          }

          step2Track.style.transform = 'translateX(-100%)';
        });
      }

      // Step 2-1b -> Step 2-2 (Model Selection)
      const modelLucaBtn = document.getElementById('model-luca');
      const modelZoraBtn = document.getElementById('model-zora');
      const modelLucaGlow = document.getElementById('model-luca-glow');
      const modelZoraGlow = document.getElementById('model-zora-glow');
      let selectedModel: string | null = null;
      
      if (modelLucaBtn) {
        modelLucaBtn.addEventListener('click', (e) => {
          e.preventDefault();
          selectedModel = 'luca';
          modelLucaBtn.classList.add('border-white/50', 'bg-white/[0.05]');
          
          // Activate golden glow effect
          if (modelLucaGlow) {
            modelLucaGlow.style.opacity = '1';
            modelLucaGlow.style.boxShadow = 'inset 0 0 20px rgba(212, 175, 55, 0.4), 0 0 30px rgba(212, 175, 55, 0.6)';
            modelLucaGlow.style.filter = 'drop-shadow(0 0 15px rgba(212, 175, 55, 0.8))';
          }
          
          if (modelZoraBtn) {
            modelZoraBtn.classList.remove('border-white/50', 'bg-white/[0.05]');
          }
          if (modelZoraGlow) {
            modelZoraGlow.style.opacity = '0';
            modelZoraGlow.style.boxShadow = 'inset 0 0 0 1px rgba(212, 175, 55, 0), 0 0 20px rgba(212, 175, 55, 0)';
            modelZoraGlow.style.filter = 'drop-shadow(0 0 0px rgba(212, 175, 55, 0))';
          }
        });
      }

      if (modelZoraBtn) {
        modelZoraBtn.addEventListener('click', (e) => {
          e.preventDefault();
          selectedModel = 'zora';
          modelZoraBtn.classList.add('border-white/50', 'bg-white/[0.05]');
          
          // Activate golden glow effect
          if (modelZoraGlow) {
            modelZoraGlow.style.opacity = '1';
            modelZoraGlow.style.boxShadow = 'inset 0 0 20px rgba(212, 175, 55, 0.4), 0 0 30px rgba(212, 175, 55, 0.6)';
            modelZoraGlow.style.filter = 'drop-shadow(0 0 15px rgba(212, 175, 55, 0.8))';
          }
          
          if (modelLucaBtn) {
            modelLucaBtn.classList.remove('border-white/50', 'bg-white/[0.05]');
          }
          if (modelLucaGlow) {
            modelLucaGlow.style.opacity = '0';
            modelLucaGlow.style.boxShadow = 'inset 0 0 0 1px rgba(212, 175, 55, 0), 0 0 20px rgba(212, 175, 55, 0)';
            modelLucaGlow.style.filter = 'drop-shadow(0 0 0px rgba(212, 175, 55, 0))';
          }
        });
      }
      
      const continueBtnStep2_1b = document.getElementById('continueBtn-step2-1b-placeholder');
      if (continueBtnStep2_1b && step2Track) {
        continueBtnStep2_1b.addEventListener('click', async (e) => {
          e.preventDefault();

          if (!selectedModel) {
            alert("Please select a calculation model.");
            return;
          }

          step2Track.style.transform = 'translateX(-200%)';
        
          // Reset to loading state explicitly
          data = {
            analysis: loadingMarkup,
            spirits: loadingMarkup,
            interpretation: loadingMarkup,
            advice: loadingMarkup,
            wisdom: loadingMarkup,
          };
          setTabContent('analysis');
          
          // Trigger Card Animation
          const cardPlaceholder = document.getElementById('step2-card-placeholder');
          const cardWheelImg = document.getElementById('card-wheel-img');

          if (cardWheelImg) {
              cardWheelImg.classList.remove('bottom-0');
              cardWheelImg.classList.add('bottom-1/2', 'translate-y-1/2');
          }

          if (cardPlaceholder) {
             // Small delay to allow slide to start/finish
             setTimeout(() => {
                 cardPlaceholder.classList.remove('translate-y-[100px]', 'opacity-0', 'blur-md');
                 cardPlaceholder.classList.add('translate-y-0', 'opacity-100', 'blur-0');
             }, 300);
          }

          // Fetch revelation content via Astro Action
          const numbers = (document.querySelectorAll('#numbers-inputs input') as NodeListOf<HTMLInputElement>);
          const question = (document.querySelector('textarea[name="custom-question"]') as HTMLTextAreaElement);
          const genderValue = (document.querySelector('input[name="gender"]:checked') as HTMLInputElement | null)?.value || 'female';
          const emailValue = (document.querySelector('input[name="email"]') as HTMLInputElement | null)?.value || '';
          const hourValue = new Date().getHours().toString();

          const minAnimationTime = 3000; // Run animation for at least 3 seconds

          try {
            const resultPromise = actions.generateRevelation({
              num1: numbers[0]?.value?.trim() || '',
              num2: numbers[1]?.value?.trim() || '',
              time: hourValue,
              gender: genderValue === 'male' ? 'male' : 'female',
              question: question.value.trim(),
              email: emailValue || undefined,
              preferredLanguage: 'English',
              visitCount: 1,
            });

            // Wait for both the result and the minimum animation time
            const [result] = await Promise.all([
              resultPromise,
              new Promise(resolve => setTimeout(resolve, minAnimationTime))
            ]);

            if (result?.error) {
              updateResultData(result.error.message || 'We could not fetch your revelation. Please try again.');
            } else if (result?.data?.text) {
              updateResultData(result.data.text);
            } else {
              updateResultData('We could not fetch your revelation. Please try again.');
            }
          } catch (error) {
            console.error('[actions] generateRevelation failed', error);
            const message = error instanceof Error ? error.message : 'We could not fetch your revelation. Please try again.';
            updateResultData(message);
          }

          // Refresh the content view immediately with the new data
          const currentTabBtn = document.querySelector('.tab-btn.active-tab');
          const currentTabKey = currentTabBtn ? currentTabBtn.getAttribute('data-tab') : 'analysis';
          setTabContent(currentTabKey);

          // Transition to Step 2-3
          if (step2Track) {
            step2Track.style.transform = 'translateX(-300%)';
          }
          if (cardWheelImg) {
              cardWheelImg.classList.remove('bottom-1/2', 'translate-y-1/2');
              cardWheelImg.classList.add('bottom-[30vh]','opacity-30');
          }
        });
      }

      // Step 2-1b Back Button
      const backBtnStep2_1b = document.getElementById('backBtn-step2-1b');
      if (backBtnStep2_1b && step2Track) {
        backBtnStep2_1b.addEventListener('click', (e) => {
          e.preventDefault();
          step2Track.style.transform = 'translateX(0)';
        });
      }


      // Step 2-3 -> Step 3 (Fly to Lantern)
      const goToStep3Btn = document.getElementById('goToStep3Btn');
      if (goToStep3Btn) {
        goToStep3Btn.addEventListener('click', () => {
          const windowWrapper = document.getElementById('window-wrapper');
          const wishOverlay = document.getElementById('wish-overlay');
          const step3 = document.getElementById('step-3');
          
          if (windowWrapper) {
            windowWrapper.style.opacity = '0';
            windowWrapper.style.transition = 'opacity 2s ease-in-out';
          }
          
          if (step3) {
             step3.classList.remove('pointer-events-none');
          }
          
          if (wishOverlay) {
            wishOverlay.classList.add('active');
          }
        });
      }

      // Wish Overlay Button Handlers
      const wishBtnExit = document.getElementById('wishBtn-exit');
      const wishBtnMake = document.getElementById('wishBtn-make');
      const wishOverlay = document.getElementById('wish-overlay');
      const step3 = document.getElementById('step-3');
      const windowWrapper = document.getElementById('window-wrapper');
      const wishInputSection = document.getElementById('wish-input-section');
      const wishNoteDisplay = document.getElementById('wish-note-display');
      const wishNoteText = document.getElementById('wish-note-text');
      const donateBtn = document.getElementById('donate-btn');
      const userWishInput = document.getElementById('user-wish') as HTMLTextAreaElement;

      if (wishBtnExit) {
        wishBtnExit.addEventListener('click', () => {
          // Go back to Step 2-1 (Manifestation Page)
          if (wishOverlay) wishOverlay.classList.remove('active');
          if (step3) step3.classList.add('pointer-events-none');
          if (windowWrapper) {
            windowWrapper.style.opacity = '1';
          }

          // Navigation back to Manifestation Page
          if (sliderTrack) sliderTrack.style.transform = 'translateX(-100%)';
          if (step2Track) step2Track.style.transform = 'translateX(0)';

          // Reset wish note state
          if (wishInputSection) wishInputSection.style.display = 'block';
          if (wishNoteDisplay) wishNoteDisplay.classList.remove('active');
          if (donateBtn) donateBtn.style.display = 'none';
        });
      }
      
      if (wishBtnMake) {
        wishBtnMake.addEventListener('click', () => {
          const wishValue = userWishInput?.value.trim();
          if (!wishValue) {
            alert("Please write your wish first.");
            return;
          }
          if (wishInputSection) wishInputSection.style.display = 'none';
          if (wishNoteText) wishNoteText.textContent = wishValue;
          if (wishNoteDisplay) wishNoteDisplay.classList.add('active');
          if (donateBtn) donateBtn.style.display = 'inline-block';
          window.location.href = 'https://buy.stripe.com/8x200lbs54G61WP94Q2kw00';
        });
      }

      // Quantity Selector Logic
      const qtyMinus = document.getElementById('qty-minus');
      const qtyPlus = document.getElementById('qty-plus');
      const qtyVal = document.getElementById('qty-val');
      const lanternsLayer = document.getElementById('lanterns-layer');
      let count = 1;

      function spawnLantern() {
        if (!lanternsLayer) return;
        const lanternCont = document.createElement('div');
        lanternCont.className = 'lantern-container extra-lantern animate';
        
        // Randomize floating path
        const startX = Math.random() * 80 + 10; // 10% to 90%
        const endX = startX + (Math.random() * 20 - 10);
        const rot = Math.random() * 40 - 20;
        
        lanternCont.style.setProperty('--start-x', startX + '%');
        lanternCont.style.setProperty('--end-x', endX + '%');
        lanternCont.style.setProperty('--rot', rot + 'deg');
        
        lanternCont.innerHTML = `
          <div class="lantern" style="transform: scale(${0.4 + Math.random() * 0.4})">
            <div class="lantern-fire"></div>
          </div>
        `;
        
        lanternsLayer.appendChild(lanternCont);
        
        // Cleanup after animation
        setTimeout(() => lanternCont.remove(), 20000);
      }

      if (qtyPlus && qtyVal) {
        qtyPlus.addEventListener('click', () => {
          if (count <1000) {
            count++;
            qtyVal.textContent = count.toString();
            spawnLantern();
          }
        });
      }

      if (qtyMinus && qtyVal) {
        qtyMinus.addEventListener('click', () => {
          if (count > 1) {
            count--;
            qtyVal.textContent = count.toString();
          }
        });
      }

      // Step 2-2 -> Step 3
      // const continueBtnStep2_2 = document.getElementById('continueBtn-step2-2');
      // const revelationLoading = document.getElementById('revelation-loading');

      // Loading Text Cycle
      const loadingText = document.getElementById('loading-text') as HTMLElement;
      const messages = [
        "<strong style='font-size: 1em;line-height: 1;'>Be Specific</strong><br/><span style='font-size: 0.8em; line-height: 1;'>Provide clear context, including your role and others involved, to help the universe pin-point your energy.</span>",
        "<strong style='font-size: 1em;line-height: 1;'>Focus on Yourself</strong><br/><span style='font-size: 0.8em;line-height: 1;'>Only ask questions that directly relate to your own path and immediate experiences.</span>",
        "<strong style='font-size: 1em;line-height: 1;'>Ask About the Near Term</strong><br/><span style='font-size: 0.8em;line-height: 1;'>Seek guidance for events occurring within the next three months for maximum accuracy.</span>",
        "<strong style='font-size: 1em;line-height: 1;'>Seek Quick Clarity</strong><br/><span style='font-size: 0.8em;line-height: 1;'>Perfect for Yes/No outcomes, finding lost items, or judging the favorability of sudden news.</span>",
        "<strong style='font-size: 1em;line-height: 1;'>One Question at a Time</strong><br/><span style='font-size: 0.8em;line-height: 1;'>Each consultation should focus on a single event to ensure a clear and unclouded response.</span>",
        "<strong style='font-size: 1em;line-height: 1;'>Center Your Intent</strong><br/><span style='font-size: 0.8em;line-height: 1;'>Approach the oracle with a firm belief and a clear mind; sincerity strengthens your cosmic link.</span>",
        "<strong style='font-size: 1em;line-height: 1;'>Find Stillness</strong><br/><span style='font-size: 0.8em;line-height: 1;'>Sit in a quiet environment and avoid consulting while walking, running, or multitasking.</span>"
      ];
      
      let msgIndex = 0;
      if (loadingText) {
        const intervalId = setInterval(() => {
          // Fade out
          loadingText.style.opacity = '0';
          
          setTimeout(() => {
            msgIndex = (msgIndex + 1) % messages.length;
            loadingText.innerHTML = messages[msgIndex];
            // Fade in
            loadingText.style.opacity = '1';
          }, 500); // Matches CSS transition duration
          
        }, 3000); // Delay 的时间除以三即可

        // Clean up on navigation to prevent multiple intervals
        document.addEventListener('astro:before-preparation', () => {
          clearInterval(intervalId);
        }, { once: true });
      }

      // ---------------------------------------------------------
      // Step 2-3 Logic: Content & Tabs
      // ---------------------------------------------------------
      const resultContent = document.getElementById('result-content');
      const tabs = document.querySelectorAll('.tab-btn');

      const loadingMarkup = `<p class="animate-pulse">Loading revelation...</p>`;
      let data: Record<string, string> = {
        analysis: loadingMarkup,
        spirits: loadingMarkup,
        interpretation: loadingMarkup,
        advice: loadingMarkup,
        wisdom: loadingMarkup,
      };

      // const escapeHtml = (value) =>
      //   value
      //     .replace(/&/g, '&amp;')
      //     .replace(/</g, '&lt;')
      //     .replace(/>/g, '&gt;')
      //     .replace(/"/g, '&quot;')
      //     .replace(/'/g, '&#39;');

      const formatResponseHtml = (text) => {
        if (!text) return '<p>No response received yet.</p>';
        
        // Basic Markdown parsing
        let html = text
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;');
          
        // Bold (**text**)
        html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        
        // Italic (*text*)
        html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
        
        // Headers (### Header)
        html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');
        html = html.replace(/^## (.*$)/gim, '<h2>$1</h2>');
        
        // Process lines for paragraphs and lists
        const lines = html.split('\n');
        let processedHtml = '';
        let inList = false;

        lines.forEach(line => {
            const trim = line.trim();
            if (!trim) {
                if (inList) {
                    processedHtml += '</ul>';
                    inList = false;
                }
                return; // Skip empty lines or treat as break?
            }
            
            // List items
            if (trim.startsWith('- ') || trim.startsWith('• ') || trim.startsWith('* ')) {
                if (!inList) {
                    processedHtml += '<ul class="list-disc pl-5 my-2">';
                    inList = true;
                }
                const content = trim.substring(1).trim(); // Remove marker
                processedHtml += `<li class="mb-1">${content}</li>`;
            } else {
                if (inList) {
                    processedHtml += '</ul>';
                    inList = false;
                }
                // Check if it's already a header
                if (trim.startsWith('<h')) {
                    processedHtml += trim;
                } else {
                    processedHtml += `<p class="mb-2">${trim}</p>`;
                }
            }
        });
        
        if (inList) processedHtml += '</ul>';

        return `<div class="revelation-text space-y-2">${processedHtml}</div>`;
      };

      const tryParseJson = (text) => {
        if (!text) return null;
        let trimmed = text.trim();
        // Remove markdown code blocks if present
        const markdownMatch = trimmed.match(/^```(?:json)?\s*([\s\S]*?)\s*```$/i);
        if (markdownMatch) {
            trimmed = markdownMatch[1].trim();
        }

        if (!trimmed.startsWith('{') || !trimmed.endsWith('}')) return null;
        try {
          return JSON.parse(trimmed);
        } catch {
          return null;
        }
      };

      const normalizeJsonSections = (value) => {
        if (!value || typeof value !== 'object') return null;
        const obj = value as Record<string, unknown>;

        // Helper to find value by multiple keys
        const getVal = (keys: string[]) => {
          for (const k of keys) {
            if (obj[k] !== undefined) return obj[k];
          }
          return undefined;
        };

        const analysisVal = getVal(['问题拆解', 'analysis']);
        const spiritsVal = getVal(['用神信息', 'spirits']);
        const interpretationVal = getVal(['解读', 'interpretation']);
        const adviceVal = getVal(['建议', 'advice']);
        const wisdomVal = getVal(['鼓励', 'wisdom']);
        const oneLineVal = getVal(['一句话结论', 'oneLine']);

        const analysis = typeof analysisVal === 'string' ? analysisVal : '';
        const spiritsArray = Array.isArray(spiritsVal) ? spiritsVal : [];
        const spirits = spiritsArray
          .filter((item) => typeof item === 'string')
          .map((item) => `• ${item}`)
          .join('\n');
        const interpretation = typeof interpretationVal === 'string' ? interpretationVal : '';
        const advice = typeof adviceVal === 'string' ? adviceVal : '';
        const wisdom = typeof wisdomVal === 'string' ? wisdomVal : '';
        const oneLine = typeof oneLineVal === 'string' ? oneLineVal : '';

        if (!analysis && !spirits && !interpretation && !advice && !wisdom && !oneLine) return null;

        const analysisWithSummary = oneLine
          ? `【一句话结论】\n${oneLine}\n\n${analysis}`.trim()
          : analysis;

        return {
          analysis: analysisWithSummary || 'No analysis provided.',
          spirits: spirits || 'No spirits provided.',
          interpretation: interpretation || 'No interpretation provided.',
          advice: advice || 'No advice provided.',
          wisdom: wisdom || 'No wisdom provided.',
        };
      };

      const updateResultData = (text) => {
        const parsed = tryParseJson(text);
        const normalized = normalizeJsonSections(parsed);

        if (normalized) {
          data = {
            analysis: formatResponseHtml(normalized.analysis),
            spirits: formatResponseHtml(normalized.spirits),
            interpretation: formatResponseHtml(normalized.interpretation),
            advice: formatResponseHtml(normalized.advice),
            wisdom: formatResponseHtml(normalized.wisdom),
          };
          return;
        }

        const html = formatResponseHtml(text);
        data = {
          analysis: html,
          spirits: html,
          interpretation: html,
          advice: html,
          wisdom: html,
        };
      };

      // Function to set content
      function setTabContent(key) {
        if (!resultContent) return;
        // Simple fade effect
        resultContent.style.opacity = '0';
        setTimeout(() => {
            resultContent.innerHTML = data[key] || '<p>Content not found.</p>';
            resultContent.style.opacity = '1';
        }, 150);
      }

      // Add click handlers
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
             // Remove active class from all
             tabs.forEach(t => t.classList.remove('active-tab'));
             // Add active to current
             tab.classList.add('active-tab');
             // Update content
             const key = tab.getAttribute('data-tab');
             setTabContent(key);
        });
      });

      // Initialize with first tab content
      if (tabs.length > 0) {
         setTabContent('analysis');
      }
      

      });
  </script>

</div>
