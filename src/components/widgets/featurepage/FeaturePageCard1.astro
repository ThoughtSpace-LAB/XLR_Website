---
import iconLoader from '~/assets/icons/icon-loader.svg?url';
import iconSend from '~/assets/icons/icon-send.svg?url';
import '~/styles/feature-text.css';
---

<div data-featurecard="1" class="visual-item-card visual-item-chat justify-end flex flex-col h-[70vh] px-[5vw] animate-slide-up-blur-delay-1">
  <div class="flex flex-col gap-6 h-fit-content">
    <div class="flex justify-start">
      <div class="bg-white/10 flex justify-start rounded-tr-[10px] rounded-bl-[10px] rounded-br-[10px] p-3 animate-float-2">
        <p class="text-small">What do the stars say about my career path this month?</p>
      </div>
    </div>
    <div class="flex justify-end">
      <div class="bg-[rgba(9,168,146,0.3)] border border-[rgba(9,168,146,0.5)] rounded-tl-[10px] rounded-bl-[10px] rounded-br-[10px] p-3 animate-float-2">
        <div class="flex items-center gap-2">
          <img src={iconLoader} alt="loader" class="w-4 h-4 animate-pulse" loading="lazy" decoding="async" />
          <span class="text-small text-[#cefafe] animate-pulse">Aligning with cosmic data...</span>
        </div>
      </div>
    </div>
  </div>

  <div class="flex justify-center p-6 pointer-events-none overflow-visible bubble-container">
    <div class="flex flex-col items-center space-y-3">
      <div class="bubble text-center body-small max-w-[360px]" data-text="Let SERENA unlock ancient wisdom and map out your destiny blueprint in high-fidelity resolution.">
        <span class="bubble-text"></span><span class="cursor" aria-hidden="true"></span>
      </div>
    </div>
  </div>

<style>
        .bubble { will-change: transform, opacity; }
        .cursor { display:inline-block; width:1px; height:1em; background: currentColor; margin-left:8px; vertical-align:bottom; animation: blink 1s steps(2) infinite; }
        @keyframes blink { 50% { opacity: 0 } }
        .moved-up { transform: translateY(-18px); transition: transform .45s cubic-bezier(.22,.9,.3,1); }
        
        /* 移动端滑动样式 */
        .scrollbar-hide {
          -ms-overflow-style: none;
          scrollbar-width: none;
        }
        .scrollbar-hide::-webkit-scrollbar { 
          display: none;
        }
        
        .mobile-card-indicator {
          cursor: pointer;
          transition: all 0.3s ease;
        }
        .mobile-card-indicator:hover {
          transform: scale(1.2);
        }
        .mobile-card-indicator.active {
          background-color: #caf1f8 !important;
        }
        
        /* 移动端内容切换样式 */
        .mobile-visual-item {
          position: absolute;
          inset: 0;
          transition: all 0.7s ease-out;
        }
        
        .mobile-bubble { 
          will-change: transform, opacity; 
        }
        .mobile-cursor { 
          display:inline-block; 
          width:1px; 
          height:1em; 
          background: currentColor; 
          margin-left:4px; 
          vertical-align:bottom; 
          animation: blink 1s steps(2) infinite; 
        }
</style>

<script type="module" is:inline>
  if (typeof window !== 'undefined') {
    

    function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }

    async function typeInto(el, text, speed=28){
      const textEl = el.querySelector('.bubble-text');
      const cursor = el.querySelector('.cursor');
      if (!textEl) return;
      if (cursor) cursor.style.opacity = '1';
      for (let i=1;i<=text.length;i++){
        textEl.textContent = text.slice(0,i);
        await sleep(speed);
      }
      await sleep(250);
      if (cursor) cursor.style.opacity = '0';
    }

    const cardEl = document.querySelector('[data-featurecard="1"]');
    if (!cardEl) return;
    const bubble = cardEl.querySelector('.bubble');
    if (!bubble) return;

    // Use closest horizontal scroller as observer root when available.
    // Fall back to the first `.overflow-x-auto` found on the page if needed.
    const scroller = cardEl.closest('.overflow-x-auto') || document.querySelector('.overflow-x-auto');
    // Lower threshold so the tiny preview inside the snap scroller still starts
    // typing when approximately half (or less) of the card becomes visible.
    const ioOptions = { root: scroller || null, threshold: 0.4 };

    let started = false;
    const obs = new IntersectionObserver((entries, ob) => {
      for (const entry of entries) {
        if (entry.isIntersecting && !started) {
          started = true;
          const text = bubble.getAttribute('data-text') || '';
          typeInto(bubble, text, 28);
          ob.disconnect();
          break;
        }
      }
    }, ioOptions);

    // If IntersectionObserver is not supported, fallback to starting the typing
    // after a short delay so older browsers still show the intended effect.
    if ('IntersectionObserver' in window) {
      obs.observe(cardEl);
    } else {
      // small delay so layout has settled
      setTimeout(() => {
        if (!started) {
          started = true;
          const text = bubble.getAttribute('data-text') || '';
          typeInto(bubble, text, 28);
        }
      }, 600);
    }
  }
</script>

  <div class="w-full h-[50px] bg-white/5 border border-white/10 rounded-full flex items-center justify-between px-6 pr-2">
    <span class="text-sm tracking-[0.4px] text-white/30">  Ask the cosmos...</span>
    <div class="w-[40px] h-[40px] bg-[rgba(0,184,219,0.2)] rounded-full flex items-center justify-center animate-pulse hover:bg-[rgba(0,184,219,0.4)] transition-colors cursor-pointer">
      <img src={iconSend} alt="send" class="w-[20px] h-[20px]" loading="lazy" decoding="async" />
    </div>
  </div>
</div>
