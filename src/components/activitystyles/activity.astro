---
import { Image } from 'astro:assets';
import '~/styles/activity/activity-background.css';
import '~/styles/feature-text.css';
import '~/styles/activity/activity-input.css';
import '~/styles/activity/activity-loading.css';
import '~/styles/activity/activity-wish.css';
import heroBg from '~/assets/images/activityimages/activity-mainbg.png';
import cardBg from '~/assets/images/activityimages/card-BG.jpg';
import cardwheel from '~/assets/images/activityimages/card-wheel.jpg';
import cardshadow from '~/assets/images/activityimages/card-shadow.jpg';
import activityline from '~/assets/images/activityimages/1activity-line.svg';
import button from '~/assets/images/activityimages/Button.png';
---

<div class="relative">
  <a href="/" aria-label="Back to home" class="fixed top-6 right-6 z-50 inline-flex items-center gap-2 py-2 px-3 bg-white/10 text-white rounded-full hover:bg-white/20 transition-all">
    ← Back
  </a>

  <section id="activity-page" class="min-h-screen w-full flex items-center justify-center bg-black">
  <div class="w-full h-full absolute inset-0 z-0 opacity-70">
    <img 
      src={heroBg.src}
      width={heroBg.width}
      height={heroBg.height}
      class="w-full h-full object-cover" 
      alt="背景图"
    />
  </div>

  <div class="relative z-10 flex flex-col items-center justify-center h-[90vh] w-[75vw]" id="window-wrapper">

  <div class="w-full h-full overflow-hidden flex items-center justify-center" id="slider-window">
    <div class="flex w-full h-full transition-transform duration-700 ease-in-out" id="slider-track">
      
      <!-- Step 1 Container -->
      <div class="w-full h-full flex-shrink-0 flex flex-col items-center justify-center" id="step-1">
        <div class="flex flex-col md:w-[45vw] w-[75vw]" id="pagewrapper">
          <h1 class="activity-headline text-center mb-4">Begin Your Wishing Journey</h1>
          <div class="w-full h-[5vh] md:h-[10vh] relative inset-0 z-0 opacity-90">
            <img 
            src={activityline.src}
            width={activityline.width}
            height={activityline.height}
            class="w-full h-[2vh] md:h-[4vh] object-contain drop-shadow-[0_0_10px_rgba(239,226,151,1)]" 
            alt="cuttingline"
            />
          </div>
          
          <h1 class="activity-paragraph text-center mb-10">
            Your information is only used to deliver your guidance.<br />
            We respect your privacy and your space.
          </h1>
          
          <!-- Gender single-choice (radio-backed) -->
          <div id="gender-input" class="nebula-input flex flex-row w-full items-center justify-center z-20">
            <div class="gender-options w-[50vw] justify-evenly mx-auto" role="radiogroup" aria-labelledby="gender-label">
              <input type="radio" id="gender-female" name="gender" value="female" required />
              <label class="gender-option" for="gender-female">Female</label>

              <input type="radio" id="gender-male" name="gender" value="male" />
              <label class="gender-option" for="gender-male">Male</label>
            </div>
            <div class="nebula-particle" style="--x:0.2; --y:-0.4; --delay:0.1s"></div>
            <div class="nebula-particle" style="--x:0.5; --y:-0.2; --delay:0.3s"></div>
          </div>

          <div id="email-input" class="nebula-input z-20 py-5 md:w-[40vw] w-[75vw] max-w-93.75 align-center">
          <input type="email" name="email" autocomplete="email" class="input w-full" required />
          <label class="user-label">Email Address</label>
          <div class="nebula-particle" style="--x:0.2; --y:-0.4; --delay:0.1s"></div>
          <div class="nebula-particle" style="--x:0.5; --y:-0.2; --delay:0.3s"></div>
          <div class="nebula-particle" style="--x:0.3; --y:0.3; --delay:0.5s"></div>
          <div class="nebula-particle" style="--x:0.7; --y:0.1; --delay:0.2s"></div>
          <div class="nebula-particle" style="--x:0.1; --y:-0.7; --delay:0.4s"></div>
          <div class="nebula-particle" style="--x:0.6; --y:0.4; --delay:0.6s"></div>
          </div>

          <!-- Continue button -->
          <div class="w-full flex items-center justify-center mt-6">
            <a href="#" class="continue-button-bg z-50 relative" id="continueBtn-step1">
              Continue
            </a>
          </div>
        </div>
      </div>

      <!-- Step 2 Container -->
      <div class="w-full h-full flex-shrink-0 flex flex-col items-center justify-center px-4" id="step-2">
        
         <!-- 卡牌背景 Card Background Wrapper -->
         <div class="relative w-full h-full justify-center overflow-hidden items-center flex " id="card-bg-wrapper">

            <div class="absolute inset-0 z-0 flex items-center justify-center">
               <img 
                 src={cardBg.src}
                 class="h-[85vh] shadow-gray-900 rounded-4xl " 
                 alt="Card Background" 
               />
            </div>
            <div class="absolute inset-0 z-10 pointer-events-none">
               <img 
                 src={cardwheel.src}
                 id="card-wheel-img"
                 class="absolute left-1/2 -translate-x-1/2 bottom-0 h-[30vh] object-contain animate-pulse transition-all duration-1000 ease-in-out" 
                 alt="Card Wheel" 
               />
            </div>

            <!-- Step 2 文字内容 -->
            <div class="relative z-10 flex flex-col items-center justify-center h-[90vh] md:w-[30vw] lg:w-[25vw] w-[300px] overflow-hidden" id="step-wrapper">
              <div class="flex w-full h-full transition-transform duration-700 ease-in-out" id="step-2-track">

                <!-- Step 2-1: Number Input and Question -->
                <div class="w-full h-full flex-shrink-0 flex flex-col items-center justify-center gap-6" id="step-2-1">
                  <a href="#" class="relative z-50 text-white/40 hover:text-white transition-all text-sm uppercase tracking-widest" id="backBtn-step2">
                  ← Back
                  </a>
              <h1 class="activity-headline text-3xl md:text-4xl text-center">Step 2</h1>
              <h1 class="activity-paragraph text-center px-2">
                  Write down 2 lucky numbers that resonate with you and ask your question.
              </h1>
                  <div class="flex flex-col" id="pagewrapper">
                    <div class="flex flex-row justify-evenly gap-6" id="numbers-inputs">
                      <div id="number-input-1" class="nebula-input relative z-20 w-30 md:w-30 lg:w-35">
                        <input required="" type="text" name="text" autocomplete="off" class="input w-full" required />
                        <label class="user-label">Number</label>
                        <div class="nebula-particle" style="--x:0.2; --y:-0.4; --delay:0.1s"></div>
                        <div class="nebula-particle" style="--x:0.5; --y:-0.2; --delay:0.3s"></div>
                        <div class="nebula-particle" style="--x:0.3; --y:0.3; --delay:0.5s"></div>
                        <div class="nebula-particle" style="--x:0.7; --y:0.1; --delay:0.2s"></div>
                        <div class="nebula-particle" style="--x:0.1; --y:-0.7; --delay:0.4s"></div>
                        <div class="nebula-particle" style="--x:0.6; --y:0.4; --delay:0.6s"></div>
                      </div>

                      <div id="number-input-2" class="nebula-input relative z-20 w-30 md:w-30 lg:w-35">
                        <input required="" type="text" name="text" autocomplete="off" class="input w-full" required />
                        <label class="user-label">Number</label>
                        <div class="nebula-particle" style="--x:0.2; --y:-0.4; --delay:0.1s"></div>
                        <div class="nebula-particle" style="--x:0.5; --y:-0.2; --delay:0.3s"></div>
                        <div class="nebula-particle" style="--x:0.3; --y:0.3; --delay:0.5s"></div>
                        <div class="nebula-particle" style="--x:0.7; --y:0.1; --delay:0.2s"></div>
                        <div class="nebula-particle" style="--x:0.1; --y:-0.7; --delay:0.4s"></div>
                        <div class="nebula-particle" style="--x:0.6; --y:0.4; --delay:0.6s"></div>
                      </div>
                    </div>
              
                    <!-- Custom Question (Line Style) -->
                    <div id="custom-question-input" class="nebula-input line-style z-20 w-full">
                      <textarea required name="custom-question" rows="1" class="input w-full resize-none overflow-hidden" placeholder=" "></textarea>
                      <label class="user-label">Ask your question...</label>
                      <div class="nebula-particle" style="--x:0.2; --y:-0.4; --delay:0.1s"></div>
                      <div class="nebula-particle" style="--x:0.5; --y:-0.2; --delay:0.3s"></div>
                      <div class="nebula-particle" style="--x:0.3; --y:0.3; --delay:0.5s"></div>
                      <div class="nebula-particle" style="--x:0.7; --y:0.1; --delay:0.2s"></div>
                      <div class="nebula-particle" style="--x:0.1; --y:-0.7; --delay:0.4s"></div>
                      <div class="nebula-particle" style="--x:0.6; --y:0.4; --delay:0.6s"></div>
                    </div>
            
                    <!-- Continue button for Step 2-1 -->
                    <div class="w-full flex justify-center mt-6">
                      <a href="#" class="continue-button-bg z-50 relative" id="continueBtn-step2-1">
                        Continue
                      </a>
                    </div>
                  </div>
                </div>

                <!-- Step 2-2: Card Selection (Placeholder for now) -->
                <div class="relative w-full h-full flex-shrink-0 flex flex-col items-center justify-center gap-6" id="step-2-2">
                   
                   <!-- Loader currently visible constantly in step 2-2 -->
                   <div class="loader-container">
                      <div class="loader"></div>
                      <div id="loading-text" class="loading-text">Casting...</div>
                   </div>

                   <div id="step2-card-placeholder" class="absolute bottom-0 left-1/2 -translate-x-1/2 flex flex-col items-center gap-8 opacity-0 blur-md translate-y-[100px] transition-all duration-1000 ease-out">
                      <img 
                      src={cardshadow.src}
                      class="h-[50vh] object-contain rounded-4xl" 
                      alt="Card Shadow" 
                      />
                   </div>
                </div>
                <!-- Step 2-3: Answer -->
                <div class="w-full h-full flex-shrink-0 flex flex-col items-center justify-center gap-6 p-4" id="step-2-3">
                    <h1 class="activity-headline text-2xl md:text-3xl text-center mb-2">The Revelation</h1>
                    
                    <!-- Tabs -->
                    <div class="flex flex-wrap gap-2 justify-center w-full max-w-4xl z-50">
                        <button class="tab-btn active-tab" data-tab="analysis">Analysis</button>
                        <button class="tab-btn" data-tab="spirits">Spirits</button>
                        <button class="tab-btn" data-tab="interpretation">Interpretation</button>
                        <button class="tab-btn" data-tab="advice">Advice</button>
                        <button class="tab-btn" data-tab="wisdom">Wisdom</button>
                    </div>

                    <!-- Content Box -->
                    <div class="w-full max-w-4xl h-[50vh] bg-black/40 backdrop-blur-md border border-white/10 rounded-xl p-6 overflow-y-auto content-box-scroll z-50 shadow-2xl">
                        <div id="result-content" class="text-white/90 text-lg leading-relaxed font-serif">
                            <!-- Content will be injected here -->
                            <p class="animate-pulse">Loading revelation...</p>
                        </div>
                    </div>
                    

                </div>
              </div>
            </div>

            <!-- Step 2-3 Overlay Logic: The Revelation -->
            <!-- Note: Revelation and Lantern are handled via overlays or top-level slider movements -->
         </div>
      </div>

    </div>

    
  </div>

  </div>

  <!-- Step 3 Container: Sky Lantern Wish (Full Screen) -->
  <div id="step-3" class="fixed inset-0 z-[100] pointer-events-none">
     <div id="wish-overlay" class="wish-overlay">
        <div id="lanterns-layer" class="absolute inset-0 pointer-events-none">
          <div class="lantern-container main-lantern">
             <div class="lantern">
                <div class="lantern-fire"></div>
             </div>
          </div>
        </div>
        
        <div class="wish-content">
           <div id="wish-input-section">
             <div class="wish-input-wrapper">
                <div class="nebula-input line-style w-full">
                  <textarea id="user-wish" name="wish" rows="1" class="input w-full resize-none overflow-hidden" placeholder=" "></textarea>
                  <label class="user-label">Write your wish here...</label>
                  <div class="nebula-particle" style="--x:0.2; --y:-0.4; --delay:0.1s"></div>
                  <div class="nebula-particle" style="--x:0.5; --y:-0.2; --delay:0.3s"></div>
                  <div class="nebula-particle" style="--x:0.3; --y:0.3; --delay:0.5s"></div>
                  <div class="nebula-particle" style="--x:0.7; --y:0.1; --delay:0.2s"></div>
                  <div class="nebula-particle" style="--x:0.1; --y:-0.7; --delay:0.4s"></div>
                  <div class="nebula-particle" style="--x:0.6; --y:0.4; --delay:0.6s"></div>
                </div>
             </div>

             <div class="quantity-selector">
                <span>Lanterns (1-20):</span>
                <button class="qty-btn" id="qty-minus">-</button>
                <span class="qty-value" id="qty-val">1</span>
                <button class="qty-btn" id="qty-plus">+</button>
             </div>

             <h2 class="wish-text">Write your wish and let it soar to the skies!</h2>
             <div class="wish-buttons">
                <button class="wish-btn" id="wishBtn-make">Make a Wish</button>
             </div>
           </div>

           <!-- Wish Note Display (Paper Paper) -->
           <div id="wish-note-display" class="wish-note">
              <p id="wish-note-text"></p>
           </div>
           
           <div class="wish-buttons mt-4">
              <button id="donate-btn" class="donate-btn">Make a Donation</button>
              <button class="wish-btn" id="wishBtn-exit">Exit</button>
           </div>
        </div>
     </div>
  </div>

  <!-- Payment Placeholder Overlay -->
  <div id="payment-overlay" class="payment-overlay">
      <div class="payment-card">
          <h2 class="activity-headline text-2xl mb-4">Secure Checkout</h2>
          <p class="text-white/60 mb-6">Redirecting to payment gateway...</p>
          <div class="loader-container !relative !h-auto my-8">
              <div class="loader"></div>
          </div>
          <button class="payment-success-btn" id="pay-complete-btn">Simulate Success</button>
      </div>
  </div>
  </section>

  <!-- / STAR ANIMATION -->


  <div class="animation-wrapper pointer-events-none" aria-hidden="true">
    <div class="particle particle-1"></div>
    <div class="particle particle-2"></div>
    <div class="particle particle-3"></div>
    <div class="particle particle-4"></div>
  </div>

  <div class="page-wrapper pointer-events-none hidden"> 
    <h4>CSS Particles</h4>
  </div>

  <div class="absolute inset-0 pointer-events-none z-0">
    <div class="container">
      <div id="particles" class="circle-container" aria-hidden="true"></div>
    </div>
  </div>

  <script type="module">
    if (typeof window !== 'undefined') {
      window.addEventListener('DOMContentLoaded', () => {
        const container = document.getElementById('particles');
        if (!container) {
          console.debug('[particles] container not found');
          return;
        }
        console.debug('[particles] initializing');
        const NUM = 60; // lowered count to reduce initial load
        for (let i = 0; i < NUM; i++) {
          const d = document.createElement('div');
          d.className = 'circle';

          const size = (Math.random() * 12 + 4).toFixed(2); // px as float
          const moveX = (Math.random() * 100).toFixed(2); // vw as float
          const moveYStart = (Math.random() * 30 + 70).toFixed(2); // vh start
          const moveYEnd = - (parseFloat(moveYStart) + Math.random() * 30).toFixed(2);
          const duration = (14 + Math.random() * 12).toFixed(2) + 's';
          const delay = (Math.random() * 11).toFixed(2) + 's';
          const scaleStart = (0.4 + Math.random() * 0.4).toFixed(2);
          const scaleMid = (1.0 + Math.random() * 0.8).toFixed(2);

          d.style.setProperty('--size', size + 'px');
          d.style.setProperty('--move-x', moveX + 'vw');
          d.style.setProperty('--move-y-start', moveYStart + 'vh');
          d.style.setProperty('--move-y-end', moveYEnd + 'vh');
          d.style.setProperty('--move-duration', duration);
          d.style.setProperty('--move-delay', delay);
          d.style.setProperty('--scale-start', scaleStart);
          d.style.setProperty('--scale-mid', scaleMid);

          // small jitter so not all start at same time
          d.style.setProperty('--fade-duration', (6 + Math.random() * 4).toFixed(2) + 's');

          container.appendChild(d);
        }
        console.debug('[particles] appended', NUM);
        // Reveal particles with a single class to avoid flash/stacking
        setTimeout(() => container.classList.add('initialized'), 50);
      });
    }
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Auto-resize textareas
      const textareas = document.querySelectorAll('.nebula-input textarea.input');
      textareas.forEach(textarea => {
        function autoResize() {
          textarea.style.height = 'auto'; // Reset height to recalculate
          textarea.style.height = (textarea.scrollHeight) + 'px';
        }
        textarea.addEventListener('input', autoResize);
        // Initial resize
        autoResize();
      });

      const sliderTrack = document.getElementById('slider-track');
      const step2Track = document.getElementById('step-2-track');

      // Step 1 -> Step 2
      const continueBtnStep1 = document.getElementById('continueBtn-step1');
      if (continueBtnStep1 && sliderTrack) {
        continueBtnStep1.addEventListener('click', (e) => {
          e.preventDefault();
          sliderTrack.style.transform = 'translateX(-100%)';
        });
      }

      // Step 2 Back Button Logic
      const backBtnStep2 = document.getElementById('backBtn-step2');
      if (backBtnStep2 && sliderTrack && step2Track) {
        backBtnStep2.addEventListener('click', (e) => {
          e.preventDefault();
          // Check if we are in Step 2-2 (translated)
          const currentTransform = step2Track.style.transform;
          
          if (currentTransform === 'translateX(-100%)') {
             // Go back to Step 2-1
             step2Track.style.transform = 'translateX(0)';
             
             // Reset Step 2-2 card animation
             const cardPlaceholder = document.getElementById('step2-card-placeholder');
             const cardWheelImg = document.getElementById('card-wheel-img');

             if (cardWheelImg) {
                cardWheelImg.classList.add('bottom-0');
                cardWheelImg.classList.remove('bottom-1/2', 'translate-y-2/3');
             }

             if(cardPlaceholder) {
                setTimeout(() => {
                    cardPlaceholder.classList.add('translate-y-[200px]', 'opacity-0', 'blur-md');
                    cardPlaceholder.classList.remove('translate-y-0', 'opacity-100', 'blur-0');
                }, 500); // Reset after transition back
             }

          } else {
             // Go back to Step 1
             sliderTrack.style.transform = 'translateX(0)';
          }
        });
      }

      // Step 2-1 -> Step 2-2
      const continueBtnStep2_1 = document.getElementById('continueBtn-step2-1');
      if (continueBtnStep2_1 && step2Track) {
        continueBtnStep2_1.addEventListener('click', (e) => {
          e.preventDefault();
          step2Track.style.transform = 'translateX(-100%)';
          
          // Trigger Card Animation
          const cardPlaceholder = document.getElementById('step2-card-placeholder');
          const cardWheelImg = document.getElementById('card-wheel-img');

          if (cardWheelImg) {
              cardWheelImg.classList.remove('bottom-0');
              cardWheelImg.classList.add('bottom-1/2', 'translate-y-1/2');
          }

          if (cardPlaceholder) {
             // Small delay to allow slide to start/finish
             setTimeout(() => {
                 cardPlaceholder.classList.remove('translate-y-[100px]', 'opacity-0', 'blur-md');
                 cardPlaceholder.classList.add('translate-y-0', 'opacity-100', 'blur-0');
             }, 300);
          }

          // Auto transition to Step 2-3 after 5s
          setTimeout(() => {
            if (step2Track) {
              step2Track.style.transform = 'translateX(-200%)';
            }
            if (cardWheelImg) {
               cardWheelImg.classList.remove('bottom-1/2', 'translate-y-1/2');
               cardWheelImg.classList.add('bottom-[60vh]');
            }

            // Transition to Step 3 after another 10s
            setTimeout(() => {
              const windowWrapper = document.getElementById('window-wrapper');
              const wishOverlay = document.getElementById('wish-overlay');
              const step3 = document.getElementById('step-3');
              
              if (windowWrapper) {
                windowWrapper.style.opacity = '0';
                windowWrapper.style.transition = 'opacity 2s ease-in-out';
              }
              
              if (step3) {
                 step3.classList.remove('pointer-events-none');
              }
              
              if (wishOverlay) {
                wishOverlay.classList.add('active');
              }
            }, 10000);
          }, 5000);
        });
      }

      // Wish Overlay Button Handlers
      const wishBtnExit = document.getElementById('wishBtn-exit');
      const wishBtnMake = document.getElementById('wishBtn-make');
      const wishOverlay = document.getElementById('wish-overlay');
      const step3 = document.getElementById('step-3');
      const windowWrapper = document.getElementById('window-wrapper');
      const paymentOverlay = document.getElementById('payment-overlay');
      const payCompleteBtn = document.getElementById('pay-complete-btn');
      const wishInputSection = document.getElementById('wish-input-section');
      const wishNoteDisplay = document.getElementById('wish-note-display');
      const wishNoteText = document.getElementById('wish-note-text');
      const donateBtn = document.getElementById('donate-btn');
      const userWishInput = document.getElementById('user-wish');

      if (wishBtnExit) {
        wishBtnExit.addEventListener('click', () => {
          // Go back to Step 2
          if (wishOverlay) wishOverlay.classList.remove('active');
          if (step3) step3.classList.add('pointer-events-none');
          if (windowWrapper) {
            windowWrapper.style.opacity = '1';
          }
          // Reset wish note state
          if (wishInputSection) wishInputSection.style.display = 'block';
          if (wishNoteDisplay) wishNoteDisplay.classList.remove('active');
          if (donateBtn) donateBtn.style.display = 'none';
        });
      }
      
      if (wishBtnMake) {
        wishBtnMake.addEventListener('click', () => {
          const wishValue = (userWishInput as HTMLTextAreaElement)?.value.trim();
          if (!wishValue) {
            alert("Please write your wish first.");
            return;
          }
          
          // Hide input part of section, keep headline or buttons visible. 
          // Actually user said "combined with the original interface".
          if (wishInputSection) wishInputSection.style.display = 'none';
          if (wishNoteText) wishNoteText.textContent = wishValue;
          if (wishNoteDisplay) wishNoteDisplay.classList.add('active');
          if (donateBtn) donateBtn.style.display = 'inline-block';
        });
      }

      if (donateBtn) {
        donateBtn.addEventListener('click', () => {
          if (paymentOverlay) paymentOverlay.classList.add('active');
        });
      }

      if (payCompleteBtn) {
        payCompleteBtn.addEventListener('click', () => {
           if (paymentOverlay) paymentOverlay.classList.remove('active');
           // Return to wish screen? User said "支付结束之后跳转回到latern界面"
           // So just hiding the payment overlay is enough.
        });
      }

      // Quantity Selector Logic
      const qtyMinus = document.getElementById('qty-minus');
      const qtyPlus = document.getElementById('qty-plus');
      const qtyVal = document.getElementById('qty-val');
      const lanternsLayer = document.getElementById('lanterns-layer');
      let count = 1;

      function spawnLantern() {
        if (!lanternsLayer) return;
        const lanternCont = document.createElement('div');
        lanternCont.className = 'lantern-container extra-lantern animate';
        
        // Randomize floating path
        const startX = Math.random() * 80 + 10; // 10% to 90%
        const endX = startX + (Math.random() * 20 - 10);
        const rot = Math.random() * 40 - 20;
        
        lanternCont.style.setProperty('--start-x', startX + '%');
        lanternCont.style.setProperty('--end-x', endX + '%');
        lanternCont.style.setProperty('--rot', rot + 'deg');
        
        lanternCont.innerHTML = `
          <div class="lantern" style="transform: scale(${0.4 + Math.random() * 0.4})">
            <div class="lantern-fire"></div>
          </div>
        `;
        
        lanternsLayer.appendChild(lanternCont);
        
        // Cleanup after animation
        setTimeout(() => lanternCont.remove(), 20000);
      }

      if (qtyPlus && qtyVal) {
        qtyPlus.addEventListener('click', () => {
          if (count < 20) {
            count++;
            qtyVal.textContent = count;
            spawnLantern();
          }
        });
      }

      if (qtyMinus && qtyVal) {
        qtyMinus.addEventListener('click', () => {
          if (count > 1) {
            count--;
            qtyVal.textContent = count;
          }
        });
      }

      // Step 2-2 -> Step 3
      const continueBtnStep2_2 = document.getElementById('continueBtn-step2-2');
      const revelationLoading = document.getElementById('revelation-loading');

      // Loading Text Cycle
      const loadingText = document.getElementById('loading-text');
      const messages = ["Casting...", "Interpreting...", "Revealing..."];
      
      let msgIndex = 0;
      if (loadingText) {
        setInterval(() => {
          // Fade out
          loadingText.style.opacity = '0';
          
          setTimeout(() => {
            msgIndex = (msgIndex + 1) % messages.length;
            loadingText.textContent = messages[msgIndex];
            // Fade in
            loadingText.style.opacity = '1';
          }, 500); // Matches CSS transition duration
          
        }, 3000); // Delay 的时间除以三即可
      }

      // ---------------------------------------------------------
      // Step 2-3 Logic: Content & Tabs
      // ---------------------------------------------------------
      const resultContent = document.getElementById('result-content');
      const tabs = document.querySelectorAll('.tab-btn');

      const data = {
analysis: `<h3 class="revelation-heading">Analysis of your Question</h3>
                   <div class="revelation-text">
                     <p>You asked about the reason why your career has been unsmooth for seven years. This question is specific and contains several key points:</p>
                     <ul class="revelation-list">
                       <li><strong>The Duration:</strong> "Seven years" indicates this is not a short-term issue but likely has deep-seated, long-standing causes.</li>
                       <li><strong>The Issue:</strong> "Career unsmoothness" covers various aspects such as career development, interpersonal relationships, income, and personal fulfillment.</li>
                       <li><strong>The Goal:</strong> Seeking the "reason" requires us to analyze from multiple angles—your personal situation, work environment, and interpersonal interactions—to identify exactly what factors have led to your career predicament.</li>
                     </ul>
                   </div>`,
                   
        spirits: `<h3 class="revelation-heading">Energy Field Information</h3>
                  <div class="spirits-container">
                    <div class="spirit-item spirit-item-gold">
                      <strong class="spirit-title">Self (The Seeker)</strong>
                      <p class="spirit-desc">Represents your mindset, capabilities, behavioral patterns, and expectations for work in the workplace.</p>
                    </div>
                    <div class="spirit-item">
                      <strong class="spirit-title">Career (Official/Ghost)</strong>
                      <p class="spirit-desc">Represents your career path, attitude of superiors, challenges, and pressures brought by the job content.</p>
                    </div>
                    <div class="spirit-item">
                      <strong class="spirit-title">Company (Parents)</strong>
                      <p class="spirit-desc">Represents your company environment, rules and regulations, documentation, and the support or resources the company or superiors can provide.</p>
                    </div>
                    <div class="spirit-item">
                      <strong class="spirit-title">Colleagues (Siblings)</strong>
                      <p class="spirit-desc">Represents your relationships with colleagues and partners, as well as potential competition and obstacles in the workplace.</p>
                    </div>
                    <div class="spirit-item">
                      <strong class="spirit-title">Wealth (Wife/Wealth)</strong>
                      <p class="spirit-desc">Represents your salary, benefits, and the actual benefits and resources gained through work.</p>
                    </div>
                  </div>`,

        interpretation: `<h3 class="revelation-heading">Detailed Interpretation</h3>
                        <div class="revelation-text">
                            <p class="mb-4">Based on the numbers “37, 26” you provided, I interpret the overall situation of your current career. The main palace falls on <strong>“Suxi” (Quick Joy)</strong>, while the deep-seated problem and root cause point to <strong>“Kongwang” (Void/Emptiness)</strong>.</p>
                            
                            <h4 class="revelation-subheading">Overall Picture</h4>
                            <p class="mb-4">“Suxi” usually represents joy, speed, and activity. However, combined with your question about “seven years of unsmoothness”, this likely implies that your career surface looks full of changes and opportunities, or you internally always crave quick success and rapid change. But this “speed” often stays on the surface without a solid foundation, causing you to be constantly busy with few substantial breakthroughs. “Kongwang” as the deep issue directly points to the core of your career struggles: many efforts ultimately come to nothing. In these seven years, you may have been constantly trying and running, but the results are often “drawing water with a bamboo basket”, leaving you exhausted and confused.</p>

                            <h4 class="revelation-subheading">Specific Aspects</h4>
                            <ul class="revelation-list space-y-4">
                            <li>
                                <strong>1. Self (The Seeker):</strong> Active and expressive, but prone to impatience. You may be talkative (Vermilion Bird) which leads to misunderstandings or friction. You might focus too much on superficial communication.
                            </li>
                            <li>
                                <strong>2. Career & Superiors:</strong> The Void aspect suggests unclear direction or lack of stability. Combined with "Flying Serpent", it hints at complex, tricky problems, rumors, or untrustworthy leadership making you feel entangled and fearful.
                            </li>
                            <li>
                                <strong>3. Company Environment:</strong> Surface activity (Suxi) masks internal instability. The "Black Tortoise" warns of opaque management, unfairness, or empty promises from superiors, consuming your trust.
                            </li>
                               <li>
                                <strong>4. Colleagues & Competition:</strong> Tension and conflict (White Tiger). You face fierce, perhaps cutthroat competition and ill-tempered opponents, leading to exhaustion.
                               </li>
                               <li>
                                <strong>5. Wealth:</strong> Also affected by Void—efforts not matching rewards. "Gouchen" implies earnings are limited by rigid systems or legal/contractual complexities.
                               </li>
                            </ul>
                        </div>`,

        advice: `<h3 class="revelation-heading">Strategic Advice</h3>
                 <div class="revelation-text">
                     <ol class="revelation-ordered-list">
                    <li>
                        <strong>Adjust Mindset, Slow Down:</strong> Stop blindly pursuing quick success; learn to settle and accumulate. Career development is long-term; haste often puts you in a passive position.
                    </li>
                    <li>
                        <strong>Review Career Path:</strong> Seriously consider if your current job suits you and has long-term potential. If the platform cannot provide substantial growth, consider changing direction. Don't waste energy in a "void".
                    </li>
                    <li>
                        <strong>Distinguish Truth:</strong> Learn to observe and avoid unnecessary disputes. Be highly vigilant about "ambiguous" internal company matters, protect your interests, and don't easily trust verbal promises.
                    </li>
                    <li>
                        <strong>Improve Relationships:</strong> Try to build good cooperative relationships to avoid senseless competition. Learn communication skills to resolve conflicts and win support.
                    </li>
                    <li>
                        <strong>Enhance Competitiveness:</strong> Since wealth is blocked, focus on improving your professional skills. Increasing your value will naturally attract better opportunities, breaking the plight of the "void".
                    </li>
                    </ol>
                 </div>`,
                 
        wisdom: `<h3 class="revelation-heading">Encouragement</h3>
                 <div class="revelation-text">
                    <div class="wisdom-quote-box">
                    "As heaven maintains vigor through movement, a gentleman should constantly strive for self-perfection."<br>
                    <span class="wisdom-source">— The I Ching</span>
                    </div>
                    <p>The career path is bumpy, but as long as you remain vigorous, never stopping, you can continue to strengthen yourself. Just as Sima Qian, after suffering humiliation, endured and worked hard to complete his masterpiece. Your seven years of hardship are a process of accumulating experience and tempering your character.</p>
                    <p class="mt-4">Do not be discouraged by the current "void". As long as you maintain the spirit of constant self-improvement and accumulate strength, you will eventually break through the mist and usher in your bright path.</p>
                 </div>`
      };

      // Function to set content
      function setTabContent(key) {
        if (!resultContent) return;
        // Simple fade effect
        resultContent.style.opacity = '0';
        setTimeout(() => {
            resultContent.innerHTML = data[key] || '<p>Content not found.</p>';
            resultContent.style.opacity = '1';
        }, 150);
      }

      // Add click handlers
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
             // Remove active class from all
             tabs.forEach(t => t.classList.remove('active-tab'));
             // Add active to current
             tab.classList.add('active-tab');
             // Update content
             const key = tab.getAttribute('data-tab');
             setTabContent(key);
        });
      });

      // Initialize with first tab content
      if (tabs.length > 0) {
         setTabContent('analysis');
      }
      

      });
  </script>

</div>
