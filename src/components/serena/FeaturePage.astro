---
import FeaturePageStickyCard from '~/components/widgets/featurepage/FeaturePageStickyCard.astro';
import ScrollAnimationScript from '~/components/common/ScrollAnimationScript.astro';
import moonicon1 from '~/assets/icons/serena/Moonicon1.svg?raw';
import moonicon2 from '~/assets/icons/serena/Moonicon2.svg?raw';
import moonicon3 from '~/assets/icons/serena/Moonicon3.svg?raw';
import '~/assets/styles/feature-text.css';


const howItWorksSteps = [
  {
    num: '01',
    title: 'The Intent',
    description: 'Anchoring your intent into the cosmic data stream. Simply ask your question to begin the alignment process. Our interface connects directly to celestial algorithms.',
    visualId: 'chat',
  },
  {
    num: '02',
    title: 'Energy Analysis',
    description: 'Our AI engine weaves ancient algorithms with real-time star charts to calculate your unique spiritual coordinates, processing thousands of celestial data points.',
    visualId: 'analysis',
  },
  {
    num: '03',
    title: 'The Revelation',
    description: 'Clarity revealed through a personalized spiritual reading, delivered with crystal clear insight. Your destiny mapped out in high fidelity resolution.',
    visualId: 'card',
  },
];
---
   

<section id="feature" class="relative bg-gradient-to-b from-[#09a892] via-[#1a6774] to-[#023344] px-5 md:px-20 py-[50px] md:py-[100px] min-h-[400vh]">
  <!-- Header -->
  <div class="flex flex-col items-center gap-[30px] md:px-[50px] lg:px-[300px] md:py-[30px] lg:py-[100px]">
    <p class="headline-large text-center bg-gradient-to-r from-white via-[#cefafe] to-[#a2f4fd] bg-clip-text text-transparent animate-slide-up-blur">
      How It Works
    </p>
    <p class="headline-small text-center leading-[24px] md:leading-[26px] font-medium tracking-[0.4px] text-[rgba(206,250,254,0.6)] max-w-[680px] animate-slide-up-blur-delay-1">
      A seamless journey from question to cosmic revelation, powered by the fusion of ancient wisdom and artificial intelligence.
    </p>
  </div>

  <!-- Timeline Content - Desktop -->
  <div class="relative hidden lg:block">
    <div class="relative flex gap-8">
      <!-- Left Column: 文字区域StickyScroll -->
      <div class="flex-1 flex flex-col">
        {howItWorksSteps.map((step, index) => (
         <div class="relative h-screen flex items-start pt-20 step-item" data-step={index}>
              <div class="sticky top-20 flex flex-col gap-3 pr-[100px] transition-opacity duration-700 ease-out step-content">
                  <p class="title-lg animate-slide-up-blur">{step.num} </p>
                  <h3 class="headline-display animate-slide-up-blur-delay-1">{step.title} </h3>
                  <p class="body-small animate-slide-up-blur-delay-2">{step.description} </p>
              </div>
          </div>
      ))}
      </div>

      <!-- Center Column: Timeline -->
      <div class="relative w-[2px] flex-shrink-0">
        <!-- Gradient Line -->
        <div class="absolute inset-0 bg-gradient-to-b from-[rgba(0,184,219,0.5)] via-[rgba(0,184,219,0.2)] to-transparent"></div>
      
        <!-- Moon Icons positioned absolutely -->
        <div class="absolute items-center moon-icon moon-1">
          <div class="w-[22px] h-[22px] items-center" set:html={moonicon1} aria-hidden="true"></div>
        </div>
        <div class="absolute items-center moon-icon moon-2">
          <div class="w-[20px] h-[20px] items-center" set:html={moonicon2} aria-hidden="true"></div>
        </div>
        <div class="absolute items-center moon-icon moon-3">
          <div class="w-[20px] h-[20px] items-center" set:html={moonicon3} aria-hidden="true"></div>
        </div>
      </div>

      <!-- Right Column: Sticky Card -->
      <div class="relative w-[560px] flex-shrink-0">
        <div class="relative h-[300vh]">
          <FeaturePageStickyCard />
        </div>
      </div>
    </div>
  </div>

  <!-- Timeline Content - Mobile (横向滑动) -->
  <div class="lg:hidden">
    <!-- 滑动容器 -->
    <div class="overflow-x-auto scrollbar-hide">
      <div class="flex snap-x snap-mandatory gap-8 pb-4" style="width: 300vw;">
        {howItWorksSteps.map((step, index) => (
          <div class="w-screen flex-shrink-0 snap-start px-4">
            <!-- Step组合 -->
            <div class="py-8">
              <!-- 文字区域 -->
              <div class="flex flex-col gap-4 mb-8">
                <div class="flex items-center gap-4">
                  <div class="w-[50px] h-[50px] rounded-full bg-[#023344] border border-[#caf1f8] shadow-[0px_0px_20px_0px_#caf1f8] flex items-center justify-center flex-shrink-0">
                    {index === 2 ? (
                      <div class="w-5 h-5 rounded-full bg-amber-500 shadow-[0px_0px_15px_0px_#f59e0b]"></div>
                    ) : (
                      <img src={index === 0 ? moonicon1 : moonicon3} alt="" class="w-full h-full object-contain" loading="lazy" decoding="async" />
                    )}
                  </div>
                  <div>
                    <p class="text-lg leading-[26px] font-normal tracking-[0.2px] text-white/70">{step.num}</p>
                    <h3 class="text-2xl leading-[32px] font-medium tracking-[0.2px] text-white capitalize">{step.title}</h3>
                  </div>
                </div>
                <p class="text-sm leading-[22px] font-normal tracking-[0.4px] text-[rgba(206,250,254,0.8)]">
                  {step.description}
                </p>
              </div>

              <!-- 月球图标 -->
              <div class="flex justify-center mb-8">
                <div class="w-[40px] h-[40px] bg-[#023344] border border-[#caf1f8] shadow-[0px_0px_20px_0px_#caf1f8] rounded-full flex items-center justify-center">
                  {index === 0 && <div class="w-[22px] h-[22px]" set:html={moonicon1}></div>}
                  {index === 1 && <div class="w-[20px] h-[20px]" set:html={moonicon2}></div>}
                  {index === 2 && <div class="w-[20px] h-[20px]" set:html={moonicon3}></div>}
                </div>
              </div>

              <!-- 卡片区域 -->
              <div>
                <FeaturePageStickyCard />
              </div>

              <!-- 横画分隔线 -->
              <div class="flex justify-center mt-8">
                <div class="w-16 h-px bg-gradient-to-r from-transparent via-[#caf1f8] to-transparent"></div>
              </div>
            </div>
          </div>
        ))}
      </div>
    </div>

    <!-- 滑动指示器 -->
    <div class="flex justify-center gap-2 mt-4">
      {howItWorksSteps.map((_, index) => (
        <div class="w-2 h-2 rounded-full bg-[#caf1f8]/30 transition-all duration-300 slide-indicator" data-index={index}></div>
      ))}
    </div>
  </div>


<script>
  if (typeof window !== 'undefined') {
    const stepContents = Array.from(document.querySelectorAll('.step-content')) as HTMLElement[];
    const visuals = Array.from(document.querySelectorAll('.visual-item')) as HTMLElement[];
    const visualMap = ['chat', 'analysis', 'card'];

    const updateActiveStep = () => {
      const scrollY = window.scrollY;
      const featureSection = document.getElementById('feature');
      if (!featureSection) return;

      const sectionTop = featureSection.offsetTop;
      const relativeScroll = scrollY - sectionTop;
      
      // 计算当前激活的步骤 (每个步骤占据一个视口高度)
      const stepIndex = Math.floor(relativeScroll / window.innerHeight);
      const activeIndex = Math.max(0, Math.min(stepIndex, 2));

      // 更新左侧步骤透明度
      stepContents.forEach((content, index) => {
        content.style.opacity = index === activeIndex ? '1' : '0.3';
      });

      // 更新右侧视觉元素
      visuals.forEach((visual) => {
        const visualId = visual.getAttribute('data-visual');
        if (visualId === visualMap[activeIndex]) {
          visual.style.opacity = '1';
          visual.style.transform = 'translateY(0)';
        } else {
          visual.style.opacity = '0';
          visual.style.transform = 'translateY(20px)';
        }
      });
    };

    updateActiveStep();
    window.addEventListener('scroll', updateActiveStep, { passive: true });

    // 横向滑动指示器功能
    const slideContainer = document.querySelector('.overflow-x-auto') as HTMLElement | null;
    const indicators = document.querySelectorAll('.slide-indicator');
    
    if (slideContainer && indicators.length > 0) {
      const sc = slideContainer as HTMLElement;
      // 更新指示器状态
      function updateIndicators() {
        const scrollLeft = sc.scrollLeft;
        const containerWidth = sc.clientWidth;
        const currentSlide = Math.round(scrollLeft / containerWidth);
        
        indicators.forEach((indicator, index) => {
          if (index === currentSlide) {
            indicator.classList.add('bg-[#caf1f8]');
            indicator.classList.remove('bg-[#caf1f8]/30');
          } else {
            indicator.classList.remove('bg-[#caf1f8]');
            indicator.classList.add('bg-[#caf1f8]/30');
          }
        });
      }

      // 监听滑动事件
      sc.addEventListener('scroll', updateIndicators, { passive: true });
      
      // 初始化指示器状态
      updateIndicators();

      // 点击指示器跳转到对应slide
      indicators.forEach((indicator, index) => {
        indicator.addEventListener('click', () => {
          const containerWidth = sc.clientWidth;
          sc.scrollTo({
            left: index * containerWidth,
            behavior: 'smooth'
          });
        });
      });
    }
  }
</script>

<style>
  /* ====== 布局样式区 ====== */
  /* 隐藏横向滚动条 */
  .scrollbar-hide {
    -ms-overflow-style: none;  /* Internet Explorer 10+ */
    scrollbar-width: none;  /* Firefox */
  }
  .scrollbar-hide::-webkit-scrollbar { 
    display: none;  /* Safari and Chrome */
  }

  /* 滑动指示器样式 */
  .slide-indicator {
    cursor: pointer;
    transition: all 0.3s ease;
  }
  .slide-indicator:hover {
    scale: 1.2;
  }

  /* Moon Icon Style */
  .moon-icon {
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    width: 50px;
    height: 50px;
    border-radius: 9999px;
    background-color: #023344;
    border: 1px solid #caf1f8;
    box-shadow: 0px 0px 20px 0px #caf1f8;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .moonicon img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    display: block;
  }

  /* Ensure any inlined SVG fills the 20x20 container */
  .moonicon svg {
    width: 100%;
    height: 100%;
    display: block;
  }

  /* Center paths/groups inside the SVG: set transform origin to center
     and ensure transforms use the SVG's bounding box. This helps
     when svg content needs to be visually centered inside the 20x20 box. */
  .moonicon svg * {
    transform-box: fill-box;
    transform-origin: center;
  }

  /* per-icon vertical placement (keeps HTML clean) */
  .moon-1 { top: 80px; }
  .moon-2 { top: calc(100vh + 80px); }
  .moon-3 { top: calc(200vh + 80px); }

  /* Typography styles moved to `src/assets/styles/feature-text.css` */
</style>

<!-- 滚动动画脚本 -->
<ScrollAnimationScript />