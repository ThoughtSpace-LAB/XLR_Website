---
/* eslint-disable */
import { Image } from 'astro:assets';
import '~/styles/activity/bless/activity-background.css';
import '~/styles/feature-text.css';
import '~/styles/activity/bless/activity-input.css';
import '~/styles/activity/bless/activity-loading.css';
import '~/styles/activity/bless/activity-wish.css';
import heroBg from '~/assets/images/activityimages/bless/activity-mainbg.png';
import cardBg from '~/assets/images/activityimages/bless/card-BG.jpg';
import cardwheel from '~/assets/images/activityimages/bless/card-wheel.jpg';
import cardshadow from '~/assets/images/activityimages/bless/card-shadow.jpg';
import activityline from '~/assets/images/activityimages/bless/1activity-line.svg';
import button from '~/assets/images/activityimages/bless/Button.png';
---

<div class="relative">
  <a href="/" aria-label="Back to home" class="fixed top-6 right-6 z-50 inline-flex items-center gap-2 py-2 px-3 bg-white/10 text-white rounded-full hover:bg-white/20 transition-all">
    ← Back
  </a>

  <section id="activity-page" class="min-h-screen w-full flex items-center justify-center bg-black">
  <div class="w-full h-full absolute inset-0 z-0 opacity-70">
    <img 
      src={heroBg.src}
      width={heroBg.width}
      height={heroBg.height}
      class="w-full h-full object-cover" 
      alt="背景图"
    />
  </div>

  <div class="relative z-10 flex flex-col items-center justify-center h-[90vh] w-[75vw]" id="window-wrapper">

  <div class="w-full h-full overflow-hidden flex items-center justify-center" id="slider-window">
    <div class="flex w-full h-full transition-transform duration-700 ease-in-out" id="slider-track">
      
      <!-- Step 1 Container -->
      <div class="w-full h-full flex-shrink-0 flex flex-col items-center justify-center" id="step-1">
        <div class="flex flex-col md:w-[45vw] w-[75vw]" id="pagewrapper">
          <h1 class="activity-headline text-center mb-4">Begin Your Wishing Journey</h1>
          <div class="w-full h-[5vh] md:h-[10vh] relative inset-0 z-0 opacity-90">
            <img 
            src={activityline.src}
            width={activityline.width}
            height={activityline.height}
            class="w-full h-[2vh] md:h-[4vh] object-contain drop-shadow-[0_0_10px_rgba(239,226,151,1)]" 
            alt="cuttingline"
            />
          </div>
          
          <h1 class="activity-paragraph text-center mb-10">
            Your information is only used to deliver your guidance.<br />
            We respect your privacy and your space.
          </h1>
          
          <!-- Gender single-choice (radio-backed) -->
          <div id="gender-input" class="nebula-input flex flex-row w-full items-center justify-center z-20">
            <div class="gender-options w-[50vw] justify-evenly mx-auto" role="radiogroup" aria-labelledby="gender-label">
              <input type="radio" id="gender-female" name="gender" value="female" required />
              <label class="gender-option" for="gender-female">Female</label>

              <input type="radio" id="gender-male" name="gender" value="male" required />
              <label class="gender-option" for="gender-male">Male</label>
            </div>
            <div class="nebula-particle" style="--x:0.2; --y:-0.4; --delay:0.1s"></div>
            <div class="nebula-particle" style="--x:0.5; --y:-0.2; --delay:0.3s"></div>
          </div>

          <div id="email-input" class="nebula-input z-20 py-5 md:w-[40vw] w-[75vw] max-w-93.75 align-center">
          <input type="email" name="email" autocomplete="email" class="input w-full" required />
          <label class="user-label">Email Address</label>
          <div class="nebula-particle" style="--x:0.2; --y:-0.4; --delay:0.1s"></div>
          <div class="nebula-particle" style="--x:0.5; --y:-0.2; --delay:0.3s"></div>
          <div class="nebula-particle" style="--x:0.3; --y:0.3; --delay:0.5s"></div>
          <div class="nebula-particle" style="--x:0.7; --y:0.1; --delay:0.2s"></div>
          <div class="nebula-particle" style="--x:0.1; --y:-0.7; --delay:0.4s"></div>
          <div class="nebula-particle" style="--x:0.6; --y:0.4; --delay:0.6s"></div>
          </div>

          <!-- Continue button -->
          <div class="w-full flex items-center justify-center mt-6">
            <a href="#" class="continue-button-bg z-50 relative" id="continueBtn-step1">
              Continue
            </a>
          </div>
        </div>
      </div>

      <!-- Step 2 Container -->
      <div class="w-full h-full flex-shrink-0 flex flex-col items-center justify-center px-4" id="step-2">
        
         <!-- 卡牌背景 Card Background Wrapper -->
         <div class="relative w-full h-full flex justify-center items-center overflow-hidden" id="card-bg-wrapper">
            <div class="absolute inset-0 z-0 flex items-center justify-center pointer-events-none">
               <img 
                 src={cardBg.src}
                 class="h-[85vh] w-auto object-contain shadow-[0_0_50px_rgba(0,0,0,0.8)] rounded-4xl" 
                 alt="Card Background" 
               />
            </div>
            <div class="absolute inset-0 z-10 pointer-events-none">
               <img 
                 src={cardwheel.src}
                 id="card-wheel-img"
                 class="absolute left-1/2 -translate-x-1/2 bottom-0 h-[30vh] object-contain animate-pulse transition-all duration-1000 ease-in-out" 
                 style="animation-duration: 2s;"
                 alt="Card Wheel" 
               />
            </div>

            <!-- Step 2 文字内容 -->
            <div class="relative z-10 flex flex-col items-center justify-center h-[90vh] md:w-[30vw] lg:w-[25vw] w-[300px] overflow-hidden" id="step-wrapper">
              <div class="flex w-full h-full transition-transform duration-700 ease-in-out" id="step-2-track">

                <!-- Step 2-1: Number Input and Question -->
                <div class="w-full h-full flex-shrink-0 flex flex-col items-center justify-center gap-6" id="step-2-1">
                  <a href="#" class="relative z-50 text-white/40 hover:text-white transition-all text-sm uppercase tracking-widest" id="backBtn-step2">
                  ← Back
                  </a>
              <h1 class="activity-headline text-3xl md:text-4xl text-center" id="Manifestation">Manifestation</h1>
              <h1 class="activity-paragraph text-center px-2">
                  Write down 2 lucky numbers that resonate with you and ask your question.
              </h1>
                  <div class="flex flex-col" id="pagewrapper">
                    <div class="flex flex-row justify-evenly gap-6" id="numbers-inputs">
                      <div id="number-input-1" class="nebula-input relative z-20 w-30 md:w-30 lg:w-35">
                        <input type="text" name="text" autocomplete="off" class="input w-full" required />
                        <label class="user-label">Number</label>
                        <div class="nebula-particle" style="--x:0.2; --y:-0.4; --delay:0.1s"></div>
                        <div class="nebula-particle" style="--x:0.5; --y:-0.2; --delay:0.3s"></div>
                        <div class="nebula-particle" style="--x:0.3; --y:0.3; --delay:0.5s"></div>
                        <div class="nebula-particle" style="--x:0.7; --y:0.1; --delay:0.2s"></div>
                        <div class="nebula-particle" style="--x:0.1; --y:-0.7; --delay:0.4s"></div>
                        <div class="nebula-particle" style="--x:0.6; --y:0.4; --delay:0.6s"></div>
                      </div>

                      <div id="number-input-2" class="nebula-input relative z-20 w-30 md:w-30 lg:w-35">
                        <input type="text" name="text" autocomplete="off" class="input w-full" required />
                        <label class="user-label">Number</label>
                        <div class="nebula-particle" style="--x:0.2; --y:-0.4; --delay:0.1s"></div>
                        <div class="nebula-particle" style="--x:0.5; --y:-0.2; --delay:0.3s"></div>
                        <div class="nebula-particle" style="--x:0.3; --y:0.3; --delay:0.5s"></div>
                        <div class="nebula-particle" style="--x:0.7; --y:0.1; --delay:0.2s"></div>
                        <div class="nebula-particle" style="--x:0.1; --y:-0.7; --delay:0.4s"></div>
                        <div class="nebula-particle" style="--x:0.6; --y:0.4; --delay:0.6s"></div>
                      </div>
                    </div>
              
                    <!-- Custom Question (Line Style) -->
                    <div id="custom-question-input" class="nebula-input line-style z-20 w-full">
                      <textarea required name="custom-question" rows="1" class="input w-full resize-none overflow-hidden" placeholder=" "></textarea>
                      <label class="user-label">Ask your question...</label>
                      <div class="nebula-particle" style="--x:0.2; --y:-0.4; --delay:0.1s"></div>
                      <div class="nebula-particle" style="--x:0.5; --y:-0.2; --delay:0.3s"></div>
                      <div class="nebula-particle" style="--x:0.3; --y:0.3; --delay:0.5s"></div>
                      <div class="nebula-particle" style="--x:0.7; --y:0.1; --delay:0.2s"></div>
                      <div class="nebula-particle" style="--x:0.1; --y:-0.7; --delay:0.4s"></div>
                      <div class="nebula-particle" style="--x:0.6; --y:0.4; --delay:0.6s"></div>
                    </div>
            
                    <!-- Continue button for Step 2-1 -->
                    <div class="w-full flex justify-center mt-6">
                      <a href="#" class="continue-button-bg z-50 relative" id="continueBtn-step2-1">
                        Continue
                      </a>
                    </div>
                  </div>
                </div>

                <!-- Step 2-2: Card Selection (Placeholder for now) -->
                <div class="relative w-full h-full flex-shrink-0 flex flex-col items-center justify-center gap-6" id="step-2-2">
                   
                   <!-- Loader currently visible constantly in step 2-2 -->
                   <div class="loader-container">
                      <div class="loader"></div>
                      <div id="loading-text" class="loading-text">Casting...</div>
                   </div>

                   <div id="step2-card-placeholder" class="absolute bottom-0 left-1/2 -translate-x-1/2 flex flex-col items-center gap-8 opacity-0 blur-md translate-y-[100px] transition-all duration-1000 ease-out">
                      <img 
                      src={cardshadow.src}
                      class="h-[50vh] object-contain rounded-4xl" 
                      alt="Card Shadow" 
                      />
                   </div>
                </div>
                <!-- Step 2-3: Answer -->
                <div class="w-full h-full flex-shrink-0 flex flex-col items-center justify-center gap-4 p-4" id="step-2-3">
                    <h1 class="activity-headline text-2xl md:text-3xl text-center mb-2">Revelation</h1>
                    
                    <!-- Tabs -->
                    <div class="flex flex-wrap gap-2 justify-center w-full max-w-4xl z-50">
                        <button class="tab-btn active-tab" data-tab="analysis">Analysis</button>
                        <button class="tab-btn" data-tab="spirits">Spirits</button>
                        <button class="tab-btn" data-tab="interpretation">Interpretation</button>
                        <button class="tab-btn" data-tab="advice">Advice</button>
                        <button class="tab-btn" data-tab="wisdom">Wisdom</button>
                    </div>

                    <!-- Content Box -->
                    <div class="w-full max-w-4xl h-[50vh] bg-black/40 backdrop-blur-md border border-white/10 rounded-xl p-6 overflow-y-auto content-box-scroll z-50 shadow-2xl">
                        <div id="result-content" class="text-white/90 text-lg leading-relaxed font-serif">
                            <!-- Content will be injected here -->
                            <p class="animate-pulse">Loading revelation...</p>
                        </div>
                    </div>
                    
                    <!-- Fly to Lantern Button -->
                    <div class="w-full flex justify-center mt-4">
                        <button id="goToStep3Btn" class="continue-button-bg z-50 relative">
                            Bless My Wish
                        </button>
                    </div>

                </div>
              </div>
            </div>

            <!-- Step 2-3 Overlay Logic: The Revelation -->
            <!-- Note: Revelation and Lantern are handled via overlays or top-level slider movements -->
         </div>
      </div>

    </div>

    
  </div>

  </div>

  <!-- Step 3 Container: Sky Lantern Wish (Full Screen) -->
  <div id="step-3" class="fixed inset-0 z-[100] pointer-events-none">
     <div id="wish-overlay" class="wish-overlay">
        <div id="lanterns-layer" class="absolute inset-0 pointer-events-none">
          <div class="lantern-container main-lantern">
             <div class="lantern">
                <div class="lantern-fire"></div>
             </div>
          </div>
        </div>
        
        <div class="wish-content">
           <div id="wish-input-section">
             <div class="wish-input-wrapper">
                <div class="nebula-input line-style w-full">
                  <textarea id="user-wish" name="wish" required rows="1" class="input w-full resize-none overflow-hidden" placeholder=" "></textarea>
                  <label class="user-label">Write your wish here...</label>
                  <div class="nebula-particle" style="--x:0.2; --y:-0.4; --delay:0.1s"></div>
                  <div class="nebula-particle" style="--x:0.5; --y:-0.2; --delay:0.3s"></div>
                  <div class="nebula-particle" style="--x:0.3; --y:0.3; --delay:0.5s"></div>
                  <div class="nebula-particle" style="--x:0.7; --y:0.1; --delay:0.2s"></div>
                  <div class="nebula-particle" style="--x:0.1; --y:-0.7; --delay:0.4s"></div>
                  <div class="nebula-particle" style="--x:0.6; --y:0.4; --delay:0.6s"></div>
                </div>
             </div>

             <div class="quantity-selector">
                <span>Lanterns</span>
                <button class="qty-btn" id="qty-minus">-</button>
                <span class="qty-value" id="qty-val">1</span>
                <button class="qty-btn" id="qty-plus">+</button>
             </div>

             <h2 class="wish-text">
               Write your wish and let it soar to the skies!<br/> 
               <span class="wish-subtext">A one-dollar contribution for each blessing lantern.</span>
             </h2>
             <div class="wish-buttons flex gap-4">
                <button class="wish-btn" id="wishBtn-make">Bless my wish</button>
                <button class="wish-btn" id="wishBtn-exit">Exit</button>
             </div>
           </div>


        </div>
     </div>
  </div>

  </section>

  <!-- / STAR ANIMATION -->


  <div class="animation-wrapper pointer-events-none" aria-hidden="true">
    <div class="particle particle-1"></div>
    <div class="particle particle-2"></div>
    <div class="particle particle-3"></div>
    <div class="particle particle-4"></div>
  </div>

  <div class="page-wrapper pointer-events-none hidden"> 
    <h4>CSS Particles</h4>
  </div>

  <div class="absolute inset-0 pointer-events-none z-0">
    <div class="container">
      <div id="particles" class="circle-container" aria-hidden="true"></div>
    </div>
  </div>

  <script >
    if (typeof window !== 'undefined') {
      document.addEventListener('astro:page-load', () => {
        const container = document.getElementById('particles');
        if (!container) {
          console.debug('[particles] container not found');
          return;
        }
        console.debug('[particles] initializing');
        const NUM = 60; // lowered count to reduce initial load
        for (let i = 0; i < NUM; i++) {
          const d = document.createElement('div');
          d.className = 'circle';

          const size = (Math.random() * 12 + 4).toFixed(2); // px as float
          const moveX = (Math.random() * 100).toFixed(2); // vw as float
          const moveYStart = (Math.random() * 30 + 70).toFixed(2); // vh start
          const moveYEnd = - (parseFloat(moveYStart) + Math.random() * 30).toFixed(2);
          const duration = (14 + Math.random() * 12).toFixed(2) + 's';
          const delay = (Math.random() * 11).toFixed(2) + 's';
          const scaleStart = (0.4 + Math.random() * 0.4).toFixed(2);
          const scaleMid = (1.0 + Math.random() * 0.8).toFixed(2);

          d.style.setProperty('--size', size + 'px');
          d.style.setProperty('--move-x', moveX + 'vw');
          d.style.setProperty('--move-y-start', moveYStart + 'vh');
          d.style.setProperty('--move-y-end', moveYEnd + 'vh');
          d.style.setProperty('--move-duration', duration);
          d.style.setProperty('--move-delay', delay);
          d.style.setProperty('--scale-start', scaleStart);
          d.style.setProperty('--scale-mid', scaleMid);

          // small jitter so not all start at same time
          d.style.setProperty('--fade-duration', (6 + Math.random() * 4).toFixed(2) + 's');

          container.appendChild(d);
        }
        console.debug('[particles] appended', NUM);
        // Reveal particles with a single class to avoid flash/stacking
        setTimeout(() => container.classList.add('initialized'), 50);
      });
    }
  </script>

  <script >
    import { actions } from 'astro:actions';

    document.addEventListener('astro:page-load', () => {
      // Auto-resize textareas
      const textareas = document.querySelectorAll('.nebula-input textarea.input') as NodeListOf<HTMLTextAreaElement>;
      textareas.forEach(textarea => {
        function autoResize() {
          textarea.style.height = 'auto'; // Reset height to recalculate
          textarea.style.height = (textarea.scrollHeight) + 'px';
        }
        textarea.addEventListener('input', autoResize);
        // Initial resize
        autoResize();
      });

      const sliderTrack = document.getElementById('slider-track');
      const step2Track = document.getElementById('step-2-track');

      // Step 1 -> Step 2
      const continueBtnStep1 = document.getElementById('continueBtn-step1');
      if (continueBtnStep1 && sliderTrack) {
        continueBtnStep1.addEventListener('click', (e) => {
          e.preventDefault();

          const gender = document.querySelector('input[name="gender"]:checked');
          const email = (document.querySelector('input[name="email"]') as HTMLInputElement);
          
          if (!gender) {
            alert("Please select your gender.");
            return;
          }
          if (!email || !email.value.trim()) {
            alert("Please enter your email address.");
            return;
          }

          sliderTrack.style.transform = 'translateX(-100%)';
        });
      }

      // Step 2 Back Button Logic
      const backBtnStep2 = document.getElementById('backBtn-step2');
      if (backBtnStep2 && sliderTrack && step2Track) {
        backBtnStep2.addEventListener('click', (e) => {
          e.preventDefault();
          // Check if we are in Step 2-2 (translated)
          const currentTransform = step2Track.style.transform;
          
          if (currentTransform === 'translateX(-100%)') {
             // Go back to Step 2-1
             step2Track.style.transform = 'translateX(0)';
             
             // Reset Step 2-2 card animation
             const cardPlaceholder = document.getElementById('step2-card-placeholder');
             const cardWheelImg = document.getElementById('card-wheel-img');

             if (cardWheelImg) {
                cardWheelImg.classList.add('bottom-0');
                cardWheelImg.classList.remove('bottom-1/2', 'translate-y-2/3');
             }

             if(cardPlaceholder) {
                setTimeout(() => {
                    cardPlaceholder.classList.add('translate-y-[200px]', 'opacity-0', 'blur-md');
                    cardPlaceholder.classList.remove('translate-y-0', 'opacity-100', 'blur-0');
                }, 500); // Reset after transition back
             }

          } else {
             // Go back to Step 1
             sliderTrack.style.transform = 'translateX(0)';
          }
        });
      }

      // Step 2-1 -> Step 2-2
      const continueBtnStep2_1 = document.getElementById('continueBtn-step2-1');
      if (continueBtnStep2_1 && step2Track) {
        continueBtnStep2_1.addEventListener('click', async (e) => {
          e.preventDefault();

          const numbers = (document.querySelectorAll('#numbers-inputs input') as NodeListOf<HTMLInputElement>);
          const question = (document.querySelector('textarea[name="custom-question"]') as HTMLTextAreaElement);
          
          let allNumbersFilled = true;
          numbers.forEach(input => {
            if (!input.value.trim()) allNumbersFilled = false;
          });
          
          if (!allNumbersFilled) {
            alert("Please enter your lucky numbers.");
            return;
          }
          if (!question || !question.value.trim()) {
            alert("Please ask your question.");
            return;
          }

          step2Track.style.transform = 'translateX(-100%)';
          updateResultData('');
          setTabContent('analysis');
          
          // Trigger Card Animation
          const cardPlaceholder = document.getElementById('step2-card-placeholder');
          const cardWheelImg = document.getElementById('card-wheel-img');

          if (cardWheelImg) {
              cardWheelImg.classList.remove('bottom-0');
              cardWheelImg.classList.add('bottom-1/2', 'translate-y-1/2');
          }

          if (cardPlaceholder) {
             // Small delay to allow slide to start/finish
             setTimeout(() => {
                 cardPlaceholder.classList.remove('translate-y-[100px]', 'opacity-0', 'blur-md');
                 cardPlaceholder.classList.add('translate-y-0', 'opacity-100', 'blur-0');
             }, 300);
          }

          // Fetch revelation content via Astro Action
          const genderValue = (document.querySelector('input[name="gender"]:checked') as HTMLInputElement | null)?.value || 'female';
          const emailValue = (document.querySelector('input[name="email"]') as HTMLInputElement | null)?.value || '';
          const hourValue = new Date().getHours().toString();

          try {
            const result = await actions.generateRevelation({
              num1: numbers[0]?.value?.trim() || '',
              num2: numbers[1]?.value?.trim() || '',
              time: hourValue,
              gender: genderValue === 'male' ? 'male' : 'female',
              question: question.value.trim(),
              email: emailValue || undefined,
              preferredLanguage: 'English',
              visitCount: 1,
            });

            if (result?.error) {
              updateResultData(result.error.message || 'We could not fetch your revelation. Please try again.');
            } else if (result?.data?.text) {
              updateResultData(result.data.text);
            } else {
              updateResultData('We could not fetch your revelation. Please try again.');
            }
          } catch (error) {
            console.error('[actions] generateRevelation failed', error);
            const message = error instanceof Error ? error.message : 'We could not fetch your revelation. Please try again.';
            updateResultData(message);
          }

          // Auto transition to Step 2-3 after 5s
          setTimeout(() => {
            if (step2Track) {
              step2Track.style.transform = 'translateX(-200%)';
            }
            if (cardWheelImg) {
               cardWheelImg.classList.remove('bottom-1/2', 'translate-y-1/2');
               cardWheelImg.classList.add('bottom-[30vh]','opacity-30');
            }
          }, 5000);
        });
      }

      // Step 2-3 -> Step 3 (Fly to Lantern)
      const goToStep3Btn = document.getElementById('goToStep3Btn');
      if (goToStep3Btn) {
        goToStep3Btn.addEventListener('click', () => {
          const windowWrapper = document.getElementById('window-wrapper');
          const wishOverlay = document.getElementById('wish-overlay');
          const step3 = document.getElementById('step-3');
          
          if (windowWrapper) {
            windowWrapper.style.opacity = '0';
            windowWrapper.style.transition = 'opacity 2s ease-in-out';
          }
          
          if (step3) {
             step3.classList.remove('pointer-events-none');
          }
          
          if (wishOverlay) {
            wishOverlay.classList.add('active');
          }
        });
      }

      // Wish Overlay Button Handlers
      const wishBtnExit = document.getElementById('wishBtn-exit');
      const wishBtnMake = document.getElementById('wishBtn-make');
      const wishOverlay = document.getElementById('wish-overlay');
      const step3 = document.getElementById('step-3');
      const windowWrapper = document.getElementById('window-wrapper');
      const wishInputSection = document.getElementById('wish-input-section');
      const wishNoteDisplay = document.getElementById('wish-note-display');
      const wishNoteText = document.getElementById('wish-note-text');
      const donateBtn = document.getElementById('donate-btn');
      const userWishInput = document.getElementById('user-wish') as HTMLTextAreaElement;

      if (wishBtnExit) {
        wishBtnExit.addEventListener('click', () => {
          // Go back to Step 2-1 (Manifestation Page)
          if (wishOverlay) wishOverlay.classList.remove('active');
          if (step3) step3.classList.add('pointer-events-none');
          if (windowWrapper) {
            windowWrapper.style.opacity = '1';
          }

          // Navigation back to Manifestation Page
          if (sliderTrack) sliderTrack.style.transform = 'translateX(-100%)';
          if (step2Track) step2Track.style.transform = 'translateX(0)';

          // Reset wish note state
          if (wishInputSection) wishInputSection.style.display = 'block';
          if (wishNoteDisplay) wishNoteDisplay.classList.remove('active');
          if (donateBtn) donateBtn.style.display = 'none';
        });
      }
      
      if (wishBtnMake) {
        wishBtnMake.addEventListener('click', () => {
          const wishValue = userWishInput?.value.trim();
          if (!wishValue) {
            alert("Please write your wish first.");
            return;
          }
          
          if (wishInputSection) wishInputSection.style.display = 'none';
          if (wishNoteText) wishNoteText.textContent = wishValue;
          if (wishNoteDisplay) wishNoteDisplay.classList.add('active');
          if (donateBtn) donateBtn.style.display = 'inline-block';
        });
      }

      // Quantity Selector Logic
      const qtyMinus = document.getElementById('qty-minus');
      const qtyPlus = document.getElementById('qty-plus');
      const qtyVal = document.getElementById('qty-val');
      const lanternsLayer = document.getElementById('lanterns-layer');
      let count = 1;

      function spawnLantern() {
        if (!lanternsLayer) return;
        const lanternCont = document.createElement('div');
        lanternCont.className = 'lantern-container extra-lantern animate';
        
        // Randomize floating path
        const startX = Math.random() * 80 + 10; // 10% to 90%
        const endX = startX + (Math.random() * 20 - 10);
        const rot = Math.random() * 40 - 20;
        
        lanternCont.style.setProperty('--start-x', startX + '%');
        lanternCont.style.setProperty('--end-x', endX + '%');
        lanternCont.style.setProperty('--rot', rot + 'deg');
        
        lanternCont.innerHTML = `
          <div class="lantern" style="transform: scale(${0.4 + Math.random() * 0.4})">
            <div class="lantern-fire"></div>
          </div>
        `;
        
        lanternsLayer.appendChild(lanternCont);
        
        // Cleanup after animation
        setTimeout(() => lanternCont.remove(), 20000);
      }

      if (qtyPlus && qtyVal) {
        qtyPlus.addEventListener('click', () => {
          if (count <1000) {
            count++;
            qtyVal.textContent = count.toString();
            spawnLantern();
          }
        });
      }

      if (qtyMinus && qtyVal) {
        qtyMinus.addEventListener('click', () => {
          if (count > 1) {
            count--;
            qtyVal.textContent = count.toString();
          }
        });
      }

      // Step 2-2 -> Step 3
      // const continueBtnStep2_2 = document.getElementById('continueBtn-step2-2');
      // const revelationLoading = document.getElementById('revelation-loading');

      // Loading Text Cycle
      const loadingText = document.getElementById('loading-text') as HTMLElement;
      const messages = ["Casting...", "Interpreting...", "Revealing..."];
      
      let msgIndex = 0;
      if (loadingText) {
        const intervalId = setInterval(() => {
          // Fade out
          loadingText.style.opacity = '0';
          
          setTimeout(() => {
            msgIndex = (msgIndex + 1) % messages.length;
            loadingText.textContent = messages[msgIndex];
            // Fade in
            loadingText.style.opacity = '1';
          }, 500); // Matches CSS transition duration
          
        }, 3000); // Delay 的时间除以三即可

        // Clean up on navigation to prevent multiple intervals
        document.addEventListener('astro:before-preparation', () => {
          clearInterval(intervalId);
        }, { once: true });
      }

      // ---------------------------------------------------------
      // Step 2-3 Logic: Content & Tabs
      // ---------------------------------------------------------
      const resultContent = document.getElementById('result-content');
      const tabs = document.querySelectorAll('.tab-btn');

      const loadingMarkup = `<p class="animate-pulse">Loading revelation...</p>`;
      let data: Record<string, string> = {
        analysis: loadingMarkup,
        spirits: loadingMarkup,
        interpretation: loadingMarkup,
        advice: loadingMarkup,
        wisdom: loadingMarkup,
      };

      const escapeHtml = (value) =>
        value
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');

      const formatResponseHtml = (text) => {
        if (!text) return '<p>No response received yet.</p>';
        const escaped = escapeHtml(text);
        const html = escaped.replace(/\n/g, '<br />');
        return `<div class="revelation-text"><p>${html}</p></div>`;
      };

      const tryParseJson = (text) => {
        if (!text) return null;
        const trimmed = text.trim();
        if (!trimmed.startsWith('{') || !trimmed.endsWith('}')) return null;
        try {
          return JSON.parse(trimmed);
        } catch {
          return null;
        }
      };

      const normalizeJsonSections = (value) => {
        if (!value || typeof value !== 'object') return null;
        const obj = value as Record<string, unknown>;
        const analysis = typeof obj['问题拆解'] === 'string' ? obj['问题拆解'] : '';
        const spiritsArray = Array.isArray(obj['用神信息']) ? obj['用神信息'] : [];
        const spirits = spiritsArray
          .filter((item) => typeof item === 'string')
          .map((item) => `• ${item}`)
          .join('\n');
        const interpretation = typeof obj['解读'] === 'string' ? obj['解读'] : '';
        const advice = typeof obj['建议'] === 'string' ? obj['建议'] : '';
        const wisdom = typeof obj['鼓励'] === 'string' ? obj['鼓励'] : '';
        const oneLine = typeof obj['一句话结论'] === 'string' ? obj['一句话结论'] : '';

        if (!analysis && !spirits && !interpretation && !advice && !wisdom && !oneLine) return null;

        const analysisWithSummary = oneLine
          ? `【一句话结论】\n${oneLine}\n\n${analysis}`.trim()
          : analysis;

        return {
          analysis: analysisWithSummary || 'No analysis provided.',
          spirits: spirits || 'No spirits provided.',
          interpretation: interpretation || 'No interpretation provided.',
          advice: advice || 'No advice provided.',
          wisdom: wisdom || 'No wisdom provided.',
        };
      };

      const updateResultData = (text) => {
        const parsed = tryParseJson(text);
        const normalized = normalizeJsonSections(parsed);

        if (normalized) {
          data = {
            analysis: formatResponseHtml(normalized.analysis),
            spirits: formatResponseHtml(normalized.spirits),
            interpretation: formatResponseHtml(normalized.interpretation),
            advice: formatResponseHtml(normalized.advice),
            wisdom: formatResponseHtml(normalized.wisdom),
          };
          return;
        }

        const html = formatResponseHtml(text);
        data = {
          analysis: html,
          spirits: html,
          interpretation: html,
          advice: html,
          wisdom: html,
        };
      };

      // Function to set content
      function setTabContent(key) {
        if (!resultContent) return;
        // Simple fade effect
        resultContent.style.opacity = '0';
        setTimeout(() => {
            resultContent.innerHTML = data[key] || '<p>Content not found.</p>';
            resultContent.style.opacity = '1';
        }, 150);
      }

      // Add click handlers
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
             // Remove active class from all
             tabs.forEach(t => t.classList.remove('active-tab'));
             // Add active to current
             tab.classList.add('active-tab');
             // Update content
             const key = tab.getAttribute('data-tab');
             setTabContent(key);
        });
      });

      // Initialize with first tab content
      if (tabs.length > 0) {
         setTabContent('analysis');
      }
      

      });
  </script>

</div>
