---

import moonicon1 from '../assets/icons/Moonicon1.svg?raw';
import moonicon2 from '../assets/icons/Moonicon2.svg?raw';
import moonicon3 from '../assets/icons/Moonicon3.svg?raw';
import '../styles/feature-text.css';
import FeaturePageCard1 from './widgets/featurepage/FeaturePageCard1.astro';
import FeaturePageCard2 from './widgets/featurepage/FeaturePageCard2.astro';
import FeaturePageCard3 from './widgets/featurepage/FeaturePageCard3.astro';
import FeaturePageStickyCard from './widgets/featurepage/FeaturePageStickyCard.astro';
import ScrollAnimationScript from './common/ScrollAnimationScript.astro';

const howItWorksSteps = [
  {
    num: '01',
    title: 'The Intent',
    description: 'Anchoring your intent into the cosmic data stream. Simply ask your question to begin the alignment process. Our interface connects directly to celestial algorithms.',
    visualId: 'chat',
  },
  {
    num: '02',
    title: 'Energy Analysis',
    description: 'Our AI engine weaves ancient algorithms with real-time star charts to calculate your unique spiritual coordinates, processing thousands of celestial data points.',
    visualId: 'analysis',
  },
  {
    num: '03',
    title: 'The Revelation',
    description: 'Clarity revealed through a personalized spiritual reading, delivered with crystal clear insight. Your destiny mapped out in high fidelity resolution.',
    visualId: 'card',
  },
];
---
   

<section id="feature" class="relative bg-gradient-to-b from-[#09a892] via-[#1a6774] to-[#023344] px-0 md:px-20 py-[50px] md:py-[100px] min-h-[150vh]">
  <!-- Header -->
  <div class="flex flex-col items-center gap-[2rem] md:px-[10vw] px-[5vw] md:py-[30px] lg:py-[100px] h-fit-content">
    <p class="headline-large text-center bg-gradient-to-r from-white via-[#cefafe] to-[#a2f4fd] bg-clip-text text-transparent animate-slide-up-blur">
      How It Works
    </p>
    <p class="headline-small text-center h-fit-content leading-[24px] md:leading-[26px] font-medium tracking-[0.4px] text-[rgba(206,250,254,0.6)] max-w-[80vw] animate-slide-up-blur-delay-1">
      A seamless journey from question to cosmic revelation, powered by the fusion of ancient wisdom and artificial intelligence.
    </p>
  </div>

  <!-- Timeline Content - Desktop -->
  <div class="relative hidden lg:block">
    <div class="relative flex gap-8">
      <!-- Left Column: 文字区域StickyScroll -->
      <div class="flex-1 flex flex-col">
        {howItWorksSteps.map((step, index) => (
         <div class="relative h-screen flex items-start pt-20 step-item" data-step={index}>
              <div class="sticky top-20 flex flex-col gap-3 pr-[100px] transition-opacity duration-700 ease-out step-content">
                  <p class="title-lg animate-slide-up-blur">{step.num} </p>
                  <h3 class="headline-display animate-slide-up-blur-delay-1">{step.title} </h3>
                  <p class="body-small animate-slide-up-blur-delay-2">{step.description} </p>
                  
              </div>
          </div>
      ))}
      </div>

      <!-- Center Column: Timeline -->
      <div class="relative w-[2px] flex-shrink-0">
        <!-- Gradient Line -->
        <div class="absolute inset-0 bg-gradient-to-b from-[rgba(0,184,219,0.5)] via-[rgba(0,184,219,0.2)] to-transparent"></div>
      
        <!-- Moon Icons positioned absolutely -->
        <div class="absolute items-center moon-icon moon-1">
          <div class="w-[22px] h-[22px] items-center" set:html={moonicon1} aria-hidden="true"></div>
        </div>
        <div class="absolute items-center moon-icon moon-2">
          <div class="w-[20px] h-[20px] items-center" set:html={moonicon2} aria-hidden="true"></div>
        </div>
        <div class="absolute items-center moon-icon moon-3">
          <div class="w-[20px] h-[20px] items-center" set:html={moonicon3} aria-hidden="true"></div>
        </div>
      </div>

      <!-- Right Column: Sticky Card -->
      <div class="relative w-[560px] flex-shrink-0">
        <div class="relative h-[300vh]">
          <FeaturePageStickyCard />
        </div>
      </div>
    </div>
  </div>

  <!-- Timeline Content - Mobile (横向滑动) -->
  <div class="lg:hidden relative">
    <!-- 固定背景卡片 -->
    <div id="cardbg" class="absolute inset-0 w-full h-full flex items-center justify-center overflow-hidden pointer-events-none z-0">
      <div class="absolute w-[85vw] h-[75vh] top-[45vh] bg-white/[0.03] rounded-3xl border border-white/15 shadow-[0px_20px_40px_0px_rgba(0,0,0,0.2),inset_0px_0px_40px_0px_rgba(9,168,146,0.1)]"> 
        <!-- Corner Dots -->
        <div class="absolute top-4 left-4 w-2 h-2 rounded-full bg-white/20"></div>
        <div class="absolute top-4 right-4 w-2 h-2 rounded-full bg-white/20"></div>
        <div class="absolute bottom-4 left-4 w-2 h-2 rounded-full bg-white/20"></div>
        <div class="absolute bottom-4 right-4 w-2 h-2 rounded-full bg-white/20"></div>
        <!-- Top Gradient Line -->
        <div class="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-white/20 to-transparent opacity-50"></div>
      </div>
    </div>

    <!-- 滑动容器 -->
    <div class="overflow-x-auto scrollbar-hide relative z-10">
      <div class="flex snap-x snap-mandatory pb-4" style="width: 300vw;">
        {howItWorksSteps.map((step, index) => (
            <div class="pt-[6rem] px-[5vw] z-0 w-[100vw] h-[150vh]">
              <!-- 文字区域 -->
              <div class="flex flex-col">
                <div class="flex items-center gap-4">
                  <div class="w-[50px] h-[50px] rounded-full bg-[#023344] border border-[#caf1f8] shadow-[0px_0px_20px_0px_#caf1f8] flex items-center justify-center flex-shrink-0">
                  <div class="flex justify-center">
                  {index === 0 && <div class="w-[22px] h-[22px]" set:html={moonicon1}></div>}
                  {index === 1 && <div class="w-[20px] h-[20px]" set:html={moonicon2}></div>}
                  {index === 2 && <div class="w-[20px] h-[20px]" set:html={moonicon3}></div>}
                  </div>
                  </div>

                  <div>
                    <p class="headline-small leading-[26px] text-white/70 animate-slide-up-blur-delay-1">{step.num}</p>
                    <h3 class="headline-md-highlight text-white capitalize animate-slide-up-blur-delay-1">{step.title}</h3>
                  </div>
                </div>
                <p class="py-6 text-medium leading-[22px] font-normal tracking-[0.4px] text-[rgba(206,250,254,0.8)] animate-slide-up-blur-delay-3">
                  {step.description}
                </p>

                <!-- Small preview of the visual card for this step (componentized) -->
                {step.visualId === 'chat' && (
                  <FeaturePageCard1 />
                )}

                {step.visualId === 'analysis' && (
                  <FeaturePageCard2 />
                )}

                {step.visualId === 'card' && (
                  <FeaturePageCard3 />
                )}

              </div>

            </div>
        ))}
      </div>
    </div>


  </div>



<script>
  if (typeof window !== 'undefined') {
    const stepContents = Array.from(document.querySelectorAll('.step-content')) as HTMLElement[];
    const visuals = Array.from(document.querySelectorAll('.visual-item')) as HTMLElement[];
    const visualMap = ['chat', 'analysis', 'card'];

    const updateActiveStep = () => {
      const scrollY = window.scrollY;
      const featureSection = document.getElementById('feature');
      if (!featureSection) return;

      const sectionTop = featureSection.offsetTop;
      const relativeScroll = scrollY - sectionTop;
      
      // 计算当前激活的步骤 (每个步骤占据一个视口高度)
      const stepIndex = Math.floor(relativeScroll / window.innerHeight);
      const activeIndex = Math.max(0, Math.min(stepIndex, 2));

      // 更新左侧步骤透明度
      stepContents.forEach((content, index) => {
        content.style.opacity = index === activeIndex ? '1' : '0.3';
      });

      // 更新右侧视觉元素
      visuals.forEach((visual) => {
        const visualId = visual.getAttribute('data-visual');
        if (visualId === visualMap[activeIndex]) {
          visual.style.opacity = '1';
          visual.style.transform = 'translateY(0)';
        } else {
          visual.style.opacity = '0';
          visual.style.transform = 'translateY(20px)';
        }
      });
    };

    updateActiveStep();
    window.addEventListener('scroll', updateActiveStep, { passive: true });

    // 横向滑动指示器功能
    const slideContainer = document.querySelector('.overflow-x-auto') as HTMLElement | null;
    const indicators = document.querySelectorAll('.slide-indicator');
    
    if (slideContainer && indicators.length > 0) {
      const sc = slideContainer as HTMLElement;
      // 更新指示器状态
      function updateIndicators() {
        const scrollLeft = sc.scrollLeft;
        const containerWidth = sc.clientWidth;
        const currentSlide = Math.round(scrollLeft / containerWidth);
        
        indicators.forEach((indicator, index) => {
          if (index === currentSlide) {
            indicator.classList.add('bg-[#caf1f8]');
            indicator.classList.remove('bg-[#caf1f8]/30');
          } else {
            indicator.classList.remove('bg-[#caf1f8]');
            indicator.classList.add('bg-[#caf1f8]/30');
          }
        });
      }

      // 监听滑动事件
      sc.addEventListener('scroll', updateIndicators, { passive: true });
      
      // 初始化指示器状态
      updateIndicators();

      // 点击指示器跳转到对应slide
      indicators.forEach((indicator, index) => {
        indicator.addEventListener('click', () => {
          const containerWidth = sc.clientWidth;
          sc.scrollTo({
            left: index * containerWidth,
            behavior: 'smooth'
          });
        });
      });
    }
  }
</script>

<style>
  /* ====== 布局样式区 ====== */
  /* 隐藏横向滚动条 */
  .scrollbar-hide {
    -ms-overflow-style: none;  /* Internet Explorer 10+ */
    scrollbar-width: none;  /* Firefox */
  }
  .scrollbar-hide::-webkit-scrollbar { 
    display: none;  /* Safari and Chrome */
  }

  /* 滑动指示器样式 */
  .slide-indicator {
    cursor: pointer;
    transition: all 0.3s ease;
  }
  .slide-indicator:hover {
    scale: 1.2;
  }

  /* Moon Icon Style */
  .moon-icon {
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    width: 50px;
    height: 50px;
    border-radius: 9999px;
    background-color: #023344;
    border: 1px solid #caf1f8;
    box-shadow: 0px 0px 20px 0px #caf1f8;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .moonicon img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    display: block;
  }

  /* Ensure any inlined SVG fills the 20x20 container */
  .moonicon svg {
    width: 100%;
    height: 100%;
    display: block;
  }

  /* Center paths/groups inside the SVG: set transform origin to center
     and ensure transforms use the SVG's bounding box. This helps
     when svg content needs to be visually centered inside the 20x20 box. */
  .moonicon svg * {
    transform-box: fill-box;
    transform-origin: center;
  }

  /* per-icon vertical placement (keeps HTML clean) */
  .moon-1 { top: 80px; }
  .moon-2 { top: calc(100vh + 80px); }
  .moon-3 { top: calc(200vh + 80px); }

  /* Typography styles moved to `src/assets/styles/feature-text.css` */
</style>

<!-- 滚动动画脚本 -->
<ScrollAnimationScript />